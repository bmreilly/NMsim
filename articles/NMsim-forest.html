<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Simulation-Based Forest Plots with NMsim • NMsim</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><script src="../extra.js"></script><meta property="og:title" content="Simulation-Based Forest Plots with NMsim">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">NMsim</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.5.923</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../index.html"><span class="fa fas fa-home fa-lg"></span></a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-vignettes" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Vignettes</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-vignettes">
<li><a class="dropdown-item" href="../articles/NMsim-intro.html">NMsim Introduction</a></li>
    <li><a class="dropdown-item" href="../articles/NMsim-VPC.html">Simulations for VPCs</a></li>
    <li><a class="dropdown-item" href="../articles/NMsim-config.html">Requirements and Configuration</a></li>
    <li><a class="dropdown-item" href="../articles/NMsim-known.html">Simulate Known Subjects</a></li>
    <li><a class="dropdown-item" href="../articles/NMsim-TypSubj.html">Simulate Typical Subjects</a></li>
    <li><a class="dropdown-item" href="../articles/NMsim-ParamUncertain.html">Simulations with Parameter Uncertainty</a></li>
    <li><a class="dropdown-item" href="../articles/NMsim-forest.html">Simulation-based forest plots with NMsim</a></li>
    <li><a class="dropdown-item" href="../articles/NMsim-DataCreate.html">Creation of Simulation Data Sets</a></li>
    <li><a class="dropdown-item" href="../articles/NMsim-ResidVar.html">Simulation with Residual Variability</a></li>
    <li><a class="dropdown-item" href="../articles/NMsim-varyPars.html">Simulate Models with Modifications</a></li>
    <li><a class="dropdown-item" href="../articles/NMsim-ReuseSimSubjects.html">Reuse Simulated Subjects</a></li>
    <li><a class="dropdown-item" href="../articles/NMsim-speed.html">Debugging, Speed, and Disk Space</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">News</a></li>
<li class="nav-item"><a class="nav-link" href="../articles/NMsim-publications.html">Publications</a></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/NMautoverse/NMsim/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/NMautoverse/NMsim/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">


<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Simulation-Based Forest Plots with NMsim</h1>
                        <h4 data-toc-skip class="author">Philip
Delff</h4>
                                    <h4 data-toc-skip class="author">Boris
Grinshpun</h4>
                        
            <h4 data-toc-skip class="date">January 06, 2025</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/NMautoverse/NMsim/blob/main/vignettes/NMsim-forest.Rmd" class="external-link"><code>vignettes/NMsim-forest.Rmd</code></a></small>
      <div class="d-none name"><code>NMsim-forest.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://yihui.org/knitr/" class="external-link">knitr</a></span><span class="op">)</span></span></code></pre></div>
<p><img src="../reference/figures/NMsimlogo240.png" align="right" height="120" alt="NMsim"></p>
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>The forest plot is an effective and widely recognized way to
illustrate estimated covariate effects on exposure or response, or
parameters related to these (e.g. clearance). The forest plot typically
includes precision of the estimate in terms of a confidence interval.
Often, an acceptance region such as the 80%-125% bio equivalence is
included for comparison.</p>
<p>In some cases, the forest plot can be derived based on model
estimates without simulation. This is the case for a forest plot on
exposure if the PK is linear and only steady-state average concentration
(or AUC) is of interest. If the PK is non-linear and/or exposure metrics
such as Cmax which depends on multiple PK parameters are of interest, a
simulation-based forest plot may be needed. As we shall see, NMsim
provides a flexible and concise framework to perform the required
simulations, a function for summarizing the simulation results is
provided, and it is demonstrated how the summary is easily plotted using
the coveffectsplot R package.</p>
<p>This vignette is no attempt to harmonize how to construct a forest
plot. Instead, we shall describe the steps taken, and it is up to the
scientist to choose how they want to construct the analysis to address
their questions most effectively.</p>
</div>
<div class="section level2">
<h2 id="initialization">Initialization<a class="anchor" aria-label="anchor" href="#initialization"></a>
</h2>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-datatable.com" class="external-link">data.table</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://NMautoverse.github.io/NMsim/">NMsim</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://nmautoverse.github.io/NMdata/" class="external-link">NMdata</a></span><span class="op">)</span>  </span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">NMcalc</span><span class="op">)</span>  <span class="co">## Optional. Used to calculate AUC.</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://smouksassi.github.io/coveffectsplot/" class="external-link">coveffectsplot</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://yihui.org/knitr/" class="external-link">knitr</a></span><span class="op">)</span> <span class="co">## for printing tables with knitr::kable</span></span>
<span></span>
<span><span class="fu"><a href="https://nmautoverse.github.io/NMdata/reference/NMdataConf.html" class="external-link">NMdataConf</a></span><span class="op">(</span></span>
<span>    path.nonmem <span class="op">=</span> <span class="st">"/opt/NONMEM/nm75/run/nmfe75"</span>, <span class="co">## path to NONMEM executable</span></span>
<span>    dir.sims<span class="op">=</span><span class="st">"simtmp-forest"</span>, <span class="co">## where to store temporary simulation results</span></span>
<span>    dir.res<span class="op">=</span><span class="st">"simres-forest"</span>   <span class="co">## where to store final simulation results</span></span>
<span>    <span class="co">## ,as.fun="data.table"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>A model is selected.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">file.mod</span> <span class="op">&lt;-</span> <span class="st">"NMsim-forest-models/xgxr134.mod"</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="generation-of-simulation-input-data">Generation of simulation input data<a class="anchor" aria-label="anchor" href="#generation-of-simulation-input-data"></a>
</h2>
<p>The simulation data set has to match the model in compartment
numbers, and it must contain all variables needed to run the NONMEM
model. We simulate daily dosing of 30 mg.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">doses</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/NMcreateDoses.html">NMcreateDoses</a></span><span class="op">(</span>TIME<span class="op">=</span><span class="fl">0</span>,AMT<span class="op">=</span><span class="fl">30</span>,ADDL<span class="op">=</span><span class="fl">100</span>,II<span class="op">=</span><span class="fl">24</span>,col.id<span class="op">=</span><span class="cn">NA</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span><span class="va">doses</span><span class="op">)</span></span></code></pre></div>
<table class="table">
<thead><tr class="header">
<th align="right">TIME</th>
<th align="right">EVID</th>
<th align="right">CMT</th>
<th align="right">AMT</th>
<th align="right">II</th>
<th align="right">ADDL</th>
<th align="right">MDV</th>
</tr></thead>
<tbody><tr class="odd">
<td align="right">0</td>
<td align="right">1</td>
<td align="right">1</td>
<td align="right">30</td>
<td align="right">24</td>
<td align="right">100</td>
<td align="right">1</td>
</tr></tbody>
</table>
<p><code><a href="../reference/expandCovs.html">NMsim::expandCovs()</a></code> can be used to construct a set of
simulations needed to derive a forest plot. It varies one covariate at a
time, keeping all other covariates at their reference value. It can
derive references and quantiles from a data set.</p>
<p>For reference values we use median in the observed population for
continuous covariates and manually select “Female” as the reference for
sex.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## reading output and input tables from estimation. Used to determine</span></span>
<span><span class="co">## reference values and quantiles.</span></span>
<span><span class="va">data.ref</span> <span class="op">&lt;-</span> <span class="fu">NMdata</span><span class="fu">::</span><span class="fu"><a href="https://nmautoverse.github.io/NMdata/reference/NMscanData.html" class="external-link">NMscanData</a></span><span class="op">(</span><span class="va">file.mod</span>,quiet<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">covs</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/expandCovs.html">expandCovs</a></span><span class="op">(</span></span>
<span>    AGE<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>ref<span class="op">=</span><span class="va">median</span>,quantiles<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">10</span>,<span class="fl">25</span>,<span class="fl">75</span>,<span class="fl">90</span><span class="op">)</span><span class="op">/</span><span class="fl">100</span>,label<span class="op">=</span><span class="st">"Age (years)"</span><span class="op">)</span>,</span>
<span>    <span class="co">## notice, values OR quantiles can be provided</span></span>
<span>    WEIGHTB<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>ref<span class="op">=</span><span class="va">median</span>, quantiles<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">10</span>,<span class="fl">25</span>,<span class="fl">75</span>,<span class="fl">90</span><span class="op">)</span><span class="op">/</span><span class="fl">100</span>, label<span class="op">=</span><span class="st">"Bodyweigt (kg)"</span><span class="op">)</span>,</span>
<span>    MALEN<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>ref<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>Female<span class="op">=</span><span class="fl">0</span><span class="op">)</span>, values<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>Male<span class="op">=</span><span class="fl">1</span><span class="op">)</span>, label<span class="op">=</span><span class="st">"Sex"</span><span class="op">)</span>,</span>
<span>    data<span class="op">=</span><span class="va">data.ref</span>,</span>
<span>    as.fun<span class="op">=</span><span class="st">"data.table"</span></span>
<span><span class="op">)</span></span>
<span><span class="co">## adding distinct ID's for each combination of covariates</span></span>
<span><span class="va">covs</span><span class="op">[</span>,<span class="va">ID</span><span class="op">:=</span><span class="va">.GRP</span>,by<span class="op">=</span><span class="fu">.</span><span class="op">(</span><span class="va">type</span>,<span class="va">covvar</span>,<span class="va">covval</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span><span class="va">covs</span><span class="op">)</span></span></code></pre></div>
<table style="width:100%;" class="table">
<colgroup>
<col width="11%">
<col width="9%">
<col width="11%">
<col width="20%">
<col width="9%">
<col width="8%">
<col width="5%">
<col width="8%">
<col width="11%">
<col width="4%">
</colgroup>
<thead><tr class="header">
<th align="left">covvar</th>
<th align="right">covval</th>
<th align="left">covvalc</th>
<th align="left">covlabel</th>
<th align="right">covref</th>
<th align="left">type</th>
<th align="right">AGE</th>
<th align="right">MALEN</th>
<th align="right">WEIGHTB</th>
<th align="right">ID</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">NA</td>
<td align="right">NA</td>
<td align="left">NA</td>
<td align="left">NA</td>
<td align="right">NA</td>
<td align="left">ref</td>
<td align="right">54</td>
<td align="right">0</td>
<td align="right">110</td>
<td align="right">1</td>
</tr>
<tr class="even">
<td align="left">AGE</td>
<td align="right">34</td>
<td align="left">34</td>
<td align="left">Age (years)</td>
<td align="right">54</td>
<td align="left">value</td>
<td align="right">34</td>
<td align="right">0</td>
<td align="right">110</td>
<td align="right">2</td>
</tr>
<tr class="odd">
<td align="left">AGE</td>
<td align="right">45</td>
<td align="left">45</td>
<td align="left">Age (years)</td>
<td align="right">54</td>
<td align="left">value</td>
<td align="right">45</td>
<td align="right">0</td>
<td align="right">110</td>
<td align="right">3</td>
</tr>
<tr class="even">
<td align="left">AGE</td>
<td align="right">65</td>
<td align="left">65</td>
<td align="left">Age (years)</td>
<td align="right">54</td>
<td align="left">value</td>
<td align="right">65</td>
<td align="right">0</td>
<td align="right">110</td>
<td align="right">4</td>
</tr>
<tr class="odd">
<td align="left">AGE</td>
<td align="right">73</td>
<td align="left">73</td>
<td align="left">Age (years)</td>
<td align="right">54</td>
<td align="left">value</td>
<td align="right">73</td>
<td align="right">0</td>
<td align="right">110</td>
<td align="right">5</td>
</tr>
<tr class="even">
<td align="left">WEIGHTB</td>
<td align="right">85</td>
<td align="left">85</td>
<td align="left">Bodyweigt (kg)</td>
<td align="right">110</td>
<td align="left">value</td>
<td align="right">54</td>
<td align="right">0</td>
<td align="right">85</td>
<td align="right">6</td>
</tr>
<tr class="odd">
<td align="left">WEIGHTB</td>
<td align="right">96</td>
<td align="left">96</td>
<td align="left">Bodyweigt (kg)</td>
<td align="right">110</td>
<td align="left">value</td>
<td align="right">54</td>
<td align="right">0</td>
<td align="right">96</td>
<td align="right">7</td>
</tr>
<tr class="even">
<td align="left">WEIGHTB</td>
<td align="right">130</td>
<td align="left">130</td>
<td align="left">Bodyweigt (kg)</td>
<td align="right">110</td>
<td align="left">value</td>
<td align="right">54</td>
<td align="right">0</td>
<td align="right">130</td>
<td align="right">8</td>
</tr>
<tr class="odd">
<td align="left">WEIGHTB</td>
<td align="right">140</td>
<td align="left">140</td>
<td align="left">Bodyweigt (kg)</td>
<td align="right">110</td>
<td align="left">value</td>
<td align="right">54</td>
<td align="right">0</td>
<td align="right">140</td>
<td align="right">9</td>
</tr>
<tr class="even">
<td align="left">MALEN</td>
<td align="right">1</td>
<td align="left">Male</td>
<td align="left">Sex</td>
<td align="right">0</td>
<td align="left">value</td>
<td align="right">54</td>
<td align="right">1</td>
<td align="right">110</td>
<td align="right">10</td>
</tr>
</tbody>
</table>
<p>We now have all combinations of covariates in the object called
<code>covs</code>. Notice the <code>type</code> column which
distinguishes the reference combination in contrast to the other
simulations where one covariate is being varied at a time.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## repeating the doses for all combinations of covariates</span></span>
<span><span class="va">dt.dos</span> <span class="op">&lt;-</span> <span class="va">covs</span><span class="op">[</span>,<span class="va">doses</span><span class="op">[</span><span class="op">]</span>,by<span class="op">=</span><span class="va">covs</span><span class="op">]</span></span>
<span><span class="fu"><a href="https://nmautoverse.github.io/NMdata/reference/dims.html" class="external-link">dims</a></span><span class="op">(</span><span class="va">covs</span>,<span class="va">doses</span>,<span class="va">dt.dos</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<table class="table">
<thead><tr class="header">
<th align="left">data</th>
<th align="right">nrows</th>
<th align="right">ncols</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">covs</td>
<td align="right">10</td>
<td align="right">10</td>
</tr>
<tr class="even">
<td align="left">doses</td>
<td align="right">1</td>
<td align="right">7</td>
</tr>
<tr class="odd">
<td align="left">dt.dos</td>
<td align="right">10</td>
<td align="right">17</td>
</tr>
</tbody>
</table>
<p>We sample every 15 minutes on the first day and one day in
steady-state.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## add a sampling scheme</span></span>
<span><span class="va">time.sim</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/data.table/man/data.table.html" class="external-link">data.table</a></span><span class="op">(</span>TIME<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">24</span>,<span class="fl">.25</span><span class="op">)</span>,period<span class="op">=</span><span class="st">"Day 1"</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/data.table/man/data.table.html" class="external-link">data.table</a></span><span class="op">(</span>TIME<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">24</span>,<span class="fl">.25</span><span class="op">)</span><span class="op">+</span><span class="fl">30</span><span class="op">*</span><span class="fl">24</span>,period<span class="op">=</span><span class="st">"Steady-State"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">dt.sim</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/addEVID2.html">addEVID2</a></span><span class="op">(</span><span class="va">dt.dos</span>,TIME<span class="op">=</span><span class="va">time.sim</span>,CMT<span class="op">=</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://nmautoverse.github.io/NMdata/reference/dims.html" class="external-link">dims</a></span><span class="op">(</span><span class="va">dt.dos</span>,<span class="va">time.sim</span>,<span class="va">dt.sim</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<table class="table">
<thead><tr class="header">
<th align="left">data</th>
<th align="right">nrows</th>
<th align="right">ncols</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">dt.dos</td>
<td align="right">10</td>
<td align="right">17</td>
</tr>
<tr class="even">
<td align="left">time.sim</td>
<td align="right">194</td>
<td align="right">2</td>
</tr>
<tr class="odd">
<td align="left">dt.sim</td>
<td align="right">1950</td>
<td align="right">18</td>
</tr>
</tbody>
</table>
<p>There is only one analyte in this data set. If for instance, you have
a parent and a metabolite, adding sampling times could look like
this:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dt.sim.parent.metab</span> <span class="op">&lt;-</span></span>
<span>    <span class="fu"><a href="../reference/addEVID2.html">addEVID2</a></span><span class="op">(</span><span class="va">dt.dos</span>,TIME<span class="op">=</span><span class="va">time.sim</span>,CMT<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>analyte<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"parent"</span>,<span class="st">"metabolite"</span><span class="op">)</span>,CMT<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>,<span class="fl">3</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>We used the <code>period</code> column to distinguish time intervals
for the analysis. We have to remember to do the postprocessing by the
values in that column. If you are looking at multiple analytes, remember
to postprocess by the column that distringuishes those, too. In this
example, that would be <code>analyte</code>.</p>
<div class="section level3">
<h3 id="simulation">Simulation<a class="anchor" aria-label="anchor" href="#simulation"></a>
</h3>
<p>We need to run the simulations repeatedly, sampling parameters based
on uncertainty estimates. This can be done in various ways. First of
all, one must choose between non-parametric and parametric sampling.
Non-parameteric sampling is typically based on a bootstrap, and the
parametetric sampling is often based on a successfull
<code>$COVARIANCE</code> step. <code>NMsim</code> has methods to do
either type, and multiple methods are available for parametric sampling.
The best source of information on these different methods is the
ACOP2024 poster <a href="../reference/figures/NMsim_param_uncertainty_web.pdf">Simulation
of clinical trial predictions with model uncertainty using NMsim</a> by
Sanaya Shroff and Philip Delff.</p>
<p>In this case we shall use parametric sampling. Since in this case we
are simulating typical subjects (random effects fixed at zero), we only
need variability on the fixed effects (THETA’s). Multiple methods are
available in <code>NMsim</code> to do this. We shall use the method
provided by NMsim based on the multivariate normal distribution
(<code>mvrnorm</code>). This method is selected because it is adequate
for sampling <code>THETA</code>’s, it does not require additional
software installed, and it is robust.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">simres.forest</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/NMsim.html">NMsim</a></span><span class="op">(</span><span class="va">file.mod</span> <span class="co"># path to NONMEM model</span></span>
<span>                      ,data<span class="op">=</span><span class="va">dt.sim</span>, <span class="co"># simulation dataset</span></span>
<span>                      ,name.sim<span class="op">=</span><span class="st">"forest_mvrnorm"</span> <span class="co"># output name suffix</span></span>
<span>                      ,method.sim<span class="op">=</span><span class="va">NMsim_VarCov</span> <span class="co"># sampling with mvrnorm</span></span>
<span>                      ,nsims<span class="op">=</span><span class="fl">500</span></span>
<span>                      ,typical<span class="op">=</span><span class="cn">TRUE</span> <span class="co"># FALSE to include BSV</span></span>
<span>                      ,table.vars<span class="op">=</span><span class="fu"><a href="https://nmautoverse.github.io/NMdata/reference/cc.html" class="external-link">cc</a></span><span class="op">(</span><span class="va">PRED</span>,<span class="va">IPRED</span><span class="op">)</span> <span class="co"># output table variables</span></span>
<span>                      ,seed.R<span class="op">=</span><span class="fl">342</span> <span class="co"># seed for reproducibility</span></span>
<span>                      ,sge<span class="op">=</span><span class="cn">TRUE</span> <span class="co"># TRUE if submitting to a cluster</span></span>
<span>                      ,nc<span class="op">=</span><span class="fl">1</span></span>
<span>                       <span class="op">)</span></span></code></pre></div>
<p>If you encounter issues with samples that do not run, consider
whether any of your uncertainty estimates on <code>THETA</code>’s could
lead to sampled <code>THETA</code>’s that could make the model be
undefined. This would often be absorption parameters, clearences,
volumes or any other strictly positive parameter which is estimated with
poor precision. If this happens, you may want to go back and estimate
that THETA on the log scale to make sure all sampled values will be
positive. A quick way to look for this is by combining parameter
estimates (from the <code>.ext</code> file) and the automatic labeling
of the parameters using <code><a href="https://nmautoverse.github.io/NMdata/reference/NMrelate.html" class="external-link">NMdata::NMrelate()</a></code>:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">NMdata</span><span class="fu">::</span><span class="fu"><a href="https://nmautoverse.github.io/NMdata/reference/NMreadExt.html" class="external-link">NMreadExt</a></span><span class="op">(</span><span class="va">file.mod</span>,as.fun<span class="op">=</span><span class="st">"data.table"</span><span class="op">)</span><span class="op">[</span><span class="va">par.type</span><span class="op">==</span><span class="st">"THETA"</span>,<span class="fu">.</span><span class="op">(</span>RSE<span class="op">=</span><span class="va">se</span><span class="op">/</span><span class="va">value</span><span class="op">)</span>,by<span class="op">=</span><span class="fu">.</span><span class="op">(</span><span class="va">par.name</span>,<span class="va">FIX</span><span class="op">)</span><span class="op">]</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">NMdata</span><span class="fu">::</span><span class="fu"><a href="https://nmautoverse.github.io/NMdata/reference/mergeCheck.html" class="external-link">mergeCheck</a></span><span class="op">(</span><span class="fu"><a href="https://nmautoverse.github.io/NMdata/reference/NMrelate.html" class="external-link">NMrelate</a></span><span class="op">(</span><span class="va">file.mod</span>,par.type<span class="op">=</span><span class="st">"THETA"</span>,as.fun<span class="op">=</span><span class="st">"data.table"</span><span class="op">)</span><span class="op">[</span>,<span class="fu">.</span><span class="op">(</span><span class="va">par.name</span>,<span class="va">code</span><span class="op">)</span><span class="op">]</span>,by<span class="op">=</span><span class="st">"par.name"</span>,quiet<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<table class="table">
<thead><tr class="header">
<th align="left">par.name</th>
<th align="right">FIX</th>
<th align="right">RSE</th>
<th align="left">code</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">THETA(1)</td>
<td align="right">0</td>
<td align="right">0.0804007</td>
<td align="left">LTVKA=THETA(1)</td>
</tr>
<tr class="even">
<td align="left">THETA(2)</td>
<td align="right">0</td>
<td align="right">0.0136327</td>
<td align="left">LTVV2=THETA(2)</td>
</tr>
<tr class="odd">
<td align="left">THETA(3)</td>
<td align="right">0</td>
<td align="right">0.0789812</td>
<td align="left">LTVCL=THETA(3)</td>
</tr>
<tr class="even">
<td align="left">THETA(4)</td>
<td align="right">0</td>
<td align="right">0.0481949</td>
<td align="left">LTVV3=THETA(4)</td>
</tr>
<tr class="odd">
<td align="left">THETA(5)</td>
<td align="right">0</td>
<td align="right">0.0292952</td>
<td align="left">LTVQ=THETA(5)</td>
</tr>
<tr class="even">
<td align="left">THETA(6)</td>
<td align="right">0</td>
<td align="right">0.4222300</td>
<td align="left">AGEEFF=THETA(6)</td>
</tr>
<tr class="odd">
<td align="left">THETA(7)</td>
<td align="right">0</td>
<td align="right">1.9160784</td>
<td align="left">WEIGHTEFF=THETA(7)</td>
</tr>
<tr class="even">
<td align="left">THETA(8)</td>
<td align="right">0</td>
<td align="right">0.1041536</td>
<td align="left">MALEEFF=THETA(8)</td>
</tr>
</tbody>
</table>
</div>
<div class="section level3">
<h3 id="post-processing">Post processing<a class="anchor" aria-label="anchor" href="#post-processing"></a>
</h3>
<p><code>NMsim</code> provides a function to do the post processing of
the set of simulations setup by <code><a href="../reference/expandCovs.html">expandCovs()</a></code>. The key steps
performed by this function are outlined below. Most importantly, it
normalizes the exposures by the reference value for each sampled set of
parameters. Then, it derives median and a confidence interval as
quantiles in the simulated distribution.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">### Read simulation results</span></span>
<span><span class="va">simres</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/NMreadSim.html">NMreadSim</a></span><span class="op">(</span><span class="st">"simres-forest/xgxr134_forest_mvrnorm_MetaData.rds"</span>,wait<span class="op">=</span><span class="cn">TRUE</span>,rm.tmp<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">## Check how many models returned simulation results</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/data.table/man/as.data.table.html" class="external-link">as.data.table</a></span><span class="op">(</span><span class="va">simres</span><span class="op">)</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/pkg/data.table/man/duplicated.html" class="external-link">uniqueN</a></span><span class="op">(</span><span class="va">model.sim</span><span class="op">)</span><span class="op">]</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 500</span></span></code></pre>
<p>If you encounter issues with samples that do not run, please consider
whether any of your uncertainty estimates on <span class="math inline">\(THETA\)</span>’s could lead to sampled THETA’s
that could make the model be undefined. This would often be absorption
parameters, clearences, volumes or any other strictly positive parameter
which is estimated with poor precision. If this happens, you may want to
go back and estimate that THETA on the log scale to make sure all
sampled values will be positive. A quick way to look into this is to
look at the relative standard error for each <code>THETA</code>. In the
following we merge in the first line in the model using each
<code>THETA</code> so we can refresh our memory on the interpretation of
each parameter without relying on a well formatted parameter table.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">NMdata</span><span class="fu">::</span><span class="fu"><a href="https://nmautoverse.github.io/NMdata/reference/NMreadExt.html" class="external-link">NMreadExt</a></span><span class="op">(</span><span class="va">file.mod</span>,as.fun<span class="op">=</span><span class="st">"data.table"</span><span class="op">)</span><span class="op">[</span></span>
<span>            <span class="va">par.type</span><span class="op">==</span><span class="st">"THETA"</span>,<span class="fu">.</span><span class="op">(</span>RSE<span class="op">=</span><span class="va">se</span><span class="op">/</span><span class="va">value</span><span class="op">)</span>,by<span class="op">=</span><span class="fu">.</span><span class="op">(</span><span class="va">par.name</span>,<span class="va">FIX</span><span class="op">)</span><span class="op">]</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">NMdata</span><span class="fu">::</span><span class="fu"><a href="https://nmautoverse.github.io/NMdata/reference/mergeCheck.html" class="external-link">mergeCheck</a></span><span class="op">(</span></span>
<span>                <span class="fu"><a href="https://nmautoverse.github.io/NMdata/reference/NMrelate.html" class="external-link">NMrelate</a></span><span class="op">(</span><span class="va">file.mod</span>,par.type<span class="op">=</span><span class="st">"THETA"</span>,as.fun<span class="op">=</span><span class="st">"data.table"</span><span class="op">)</span><span class="op">[</span>,<span class="fu">.</span><span class="op">(</span><span class="va">par.name</span>,<span class="va">code</span><span class="op">)</span><span class="op">]</span>,</span>
<span>                by<span class="op">=</span><span class="st">"par.name"</span>,quiet<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<div data-pagedtable="false">
<script data-pagedtable-source type="application/json">
{"columns":[{"label":["par.name"],"name":[1],"type":["chr"],"align":["left"]},{"label":["FIX"],"name":[2],"type":["dbl"],"align":["right"]},{"label":["RSE"],"name":[3],"type":["dbl"],"align":["right"]},{"label":["code"],"name":[4],"type":["chr"],"align":["left"]}],"data":[{"1":"THETA(1)","2":"0","3":"0.08040069","4":"LTVKA=THETA(1)"},{"1":"THETA(2)","2":"0","3":"0.01363271","4":"LTVV2=THETA(2)"},{"1":"THETA(3)","2":"0","3":"0.07898119","4":"LTVCL=THETA(3)"},{"1":"THETA(4)","2":"0","3":"0.04819492","4":"LTVV3=THETA(4)"},{"1":"THETA(5)","2":"0","3":"0.02929518","4":"LTVQ=THETA(5)"},{"1":"THETA(6)","2":"0","3":"0.42222998","4":"AGEEFF=THETA(6)"},{"1":"THETA(7)","2":"0","3":"1.91607839","4":"WEIGHTEFF=THETA(7)"},{"1":"THETA(8)","2":"0","3":"0.10415356","4":"MALEEFF=THETA(8)"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
<p>The step required by the user is to define the functions to derive
relevant exposure metrics. We will use AUC 0-24h and Cmax.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">### Define exposure metrics</span></span>
<span><span class="va">funs.exposure</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    <span class="st">"Cmax"</span><span class="op">=</span><span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">x</span><span class="op">$</span><span class="va">PRED</span><span class="op">)</span></span>
<span>   ,<span class="st">"AUC"</span><span class="op">=</span><span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/pkg/NMcalc/man/trapez.html" class="external-link">trapez</a></span><span class="op">(</span><span class="va">x</span><span class="op">$</span><span class="va">TIME</span>,<span class="va">x</span><span class="op">$</span><span class="va">PRED</span><span class="op">)</span></span>
<span>    <span class="co">## ,"Concentration at 4 hours"=function(x) x$value[x$TAPD==4]</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">sum.uncertain</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/summarizeCovs.html">summarizeCovs</a></span><span class="op">(</span><span class="va">simres</span>,</span>
<span>                                 funs.exposure <span class="op">=</span> <span class="va">funs.exposure</span>,</span>
<span>                                 by<span class="op">=</span><span class="fu"><a href="https://nmautoverse.github.io/NMdata/reference/cc.html" class="external-link">cc</a></span><span class="op">(</span><span class="va">period</span><span class="op">)</span>,</span>
<span>                                 cover.ci<span class="op">=</span><span class="fl">.95</span></span>
<span>                                 <span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="plotting">Plotting<a class="anchor" aria-label="anchor" href="#plotting"></a>
</h3>
<p>We will use the R package <code>coveffectsplot</code> for plotting.
<code><a href="https://smouksassi.github.io/coveffectsplot/reference/forest_plot.html" class="external-link">coveffectsplot::forest_plot()</a></code> requires certain column names
so we adjust those first.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/data.table/man/setDT.html" class="external-link">setDT</a></span><span class="op">(</span><span class="va">sum.uncertain</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/data.table/man/setattr.html" class="external-link">setnames</a></span><span class="op">(</span><span class="va">sum.uncertain</span>,</span>
<span>         <span class="fu"><a href="https://nmautoverse.github.io/NMdata/reference/cc.html" class="external-link">cc</a></span><span class="op">(</span><span class="va">covvalf</span>,<span class="va">predmm</span>,<span class="va">predml</span>,<span class="va">predmu</span>,<span class="va">metric.var</span><span class="op">)</span>,</span>
<span>         <span class="fu"><a href="https://nmautoverse.github.io/NMdata/reference/cc.html" class="external-link">cc</a></span><span class="op">(</span><span class="va">label</span>,<span class="va">mid</span>,<span class="va">lower</span>,<span class="va">upper</span>,<span class="va">paramname</span><span class="op">)</span></span>
<span>         <span class="op">)</span></span>
<span></span>
<span><span class="va">sum.uncertain</span><span class="op">[</span>,<span class="va">MEANVAL</span><span class="op">:=</span><span class="va">mid</span><span class="op">]</span></span>
<span><span class="va">sum.uncertain</span><span class="op">[</span>,<span class="va">covname</span><span class="op">:=</span><span class="va">covlabel</span><span class="op">]</span></span>
<span><span class="va">nsig</span> <span class="op">&lt;-</span> <span class="fl">3</span></span>
<span><span class="va">sum.uncertain</span><span class="op">[</span>,<span class="va">LABEL</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"%s [%s - %s]"</span>,<span class="fu"><a href="https://rdrr.io/pkg/NMcalc/man/signif2.html" class="external-link">signif2</a></span><span class="op">(</span><span class="va">mid</span>,<span class="va">nsig</span><span class="op">)</span>,<span class="fu"><a href="https://rdrr.io/pkg/NMcalc/man/signif2.html" class="external-link">signif2</a></span><span class="op">(</span><span class="va">lower</span>,<span class="va">nsig</span><span class="op">)</span>,<span class="fu"><a href="https://rdrr.io/pkg/NMcalc/man/signif2.html" class="external-link">signif2</a></span><span class="op">(</span><span class="va">upper</span>,<span class="va">nsig</span><span class="op">)</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span></span>
<span><span class="va">descrip.legend</span> <span class="op">&lt;-</span> <span class="st">"Reference (vertical line)\nClinically relevant limits 0.8-1.25 (colored area)"</span></span>
<span></span>
<span><span class="co">### I don't know why forest_plot() needs this </span></span>
<span><span class="va">label_value</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>,<span class="va">...</span> <span class="op">)</span><span class="va">x</span></span>
<span></span>
<span><span class="va">fun.plot</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span>,<span class="va">...</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">textsize</span> <span class="op">&lt;-</span> <span class="fl">10</span></span>
<span>    <span class="va">forest1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://smouksassi.github.io/coveffectsplot/reference/forest_plot.html" class="external-link">forest_plot</a></span><span class="op">(</span></span>
<span>        data <span class="op">=</span> <span class="va">data</span>,</span>
<span>        facet_formula <span class="op">=</span> <span class="st">"covlabel ~ paramname"</span>, </span>
<span>        facet_scales <span class="op">=</span> <span class="st">"free_y"</span>,</span>
<span>        facet_space <span class="op">=</span> <span class="st">"free_y"</span>,</span>
<span>        xy_facet_text_bold <span class="op">=</span> <span class="cn">FALSE</span>, </span>
<span>        plot_table_ratio <span class="op">=</span> <span class="fl">1.7</span>, </span>
<span>        table_text_size <span class="op">=</span> <span class="fl">3</span>,</span>
<span>        x_label_text_size <span class="op">=</span> <span class="va">textsize</span>,</span>
<span>        y_label_text_size <span class="op">=</span> <span class="va">textsize</span>, </span>
<span>        x_facet_text_size <span class="op">=</span> <span class="va">textsize</span>, </span>
<span>        y_facet_text_size <span class="op">=</span> <span class="va">textsize</span>,</span>
<span>        base_size<span class="op">=</span><span class="va">textsize</span>,</span>
<span>        strip_placement <span class="op">=</span> <span class="st">"outside"</span>,</span>
<span>        table_position <span class="op">=</span> <span class="st">"right"</span>,</span>
<span>        legend_order <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"pointinterval"</span>, <span class="st">"ref"</span>, <span class="st">"area"</span><span class="op">)</span>,</span>
<span>        x_range <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">.5</span>,<span class="fl">1.5</span><span class="op">)</span>,</span>
<span>        ref_legend_text <span class="op">=</span> <span class="va">descrip.legend</span>,</span>
<span>        area_legend_text <span class="op">=</span> <span class="va">descrip.legend</span>,</span>
<span>        facet_switch <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"y"</span><span class="op">)</span>,</span>
<span>        legend_position<span class="op">=</span><span class="st">"bottom"</span>,</span>
<span>        <span class="va">...</span></span>
<span>    <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">forest.day1</span> <span class="op">&lt;-</span> <span class="fu">fun.plot</span><span class="op">(</span><span class="va">sum.uncertain</span><span class="op">[</span><span class="va">period</span><span class="op">==</span><span class="st">"Day 1"</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Error in get(paste0(generic, ".", class), envir = get_method_env()) : </span></span>
<span><span class="co">##   object 'type_sum.accel' not found</span></span></code></pre>
<pre><code><span><span class="co">## Warning: The `&lt;scale&gt;` argument of `guides()` cannot be `FALSE`. Use "none" instead as</span></span>
<span><span class="co">## of ggplot2 3.3.4.</span></span>
<span><span class="co">## <span style="color: #00BBBB;">ℹ</span> The deprecated feature was likely used in the <span style="color: #0000BB;">coveffectsplot</span> package.</span></span>
<span><span class="co">##   Please report the issue at</span></span>
<span><span class="co">##   <span style="color: #0000BB; font-style: italic;">&lt;https://github.com/smouksassi/coveffectsplot/issues&gt;</span>.</span></span>
<span><span class="co">## <span style="color: #555555;">This warning is displayed once every 8 hours.</span></span></span>
<span><span class="co">## <span style="color: #555555;">Call `lifecycle::last_lifecycle_warnings()` to see where this warning was</span></span></span>
<span><span class="co">## <span style="color: #555555;">generated.</span></span></span></code></pre>
<p><img src="NMsim-forest_files/figure-html/unnamed-chunk-13-1.png" width="960"></p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">forest.ss</span> <span class="op">&lt;-</span> <span class="fu">fun.plot</span><span class="op">(</span><span class="va">sum.uncertain</span><span class="op">[</span><span class="va">period</span><span class="op">==</span><span class="st">"Steady-State"</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<p><img src="NMsim-forest_files/figure-html/unnamed-chunk-13-2.png" width="960"></p>
</div>
<div class="section level3">
<h3 id="post-processing-explained-step-by-step">Post processing explained step by step<a class="anchor" aria-label="anchor" href="#post-processing-explained-step-by-step"></a>
</h3>
<p>We are including the code from the main steps in the post processing
function, <code><a href="../reference/summarizeCovs.html">NMsim::summarizeCovs()</a></code>. It is important that the
scientist understands that what the forest plots derived in this
document represent is the relative effect of the covariate on the
exposure metric. This is derived by <code><a href="../reference/summarizeCovs.html">NMsim::summarizeCovs()</a></code>
as quantiles of the exposure relative to the reference subject. The
confidence interval hence expresses the uncertainty on the covariate
effect for a subject with other covariates at reference values.</p>
<p>Notice, the code below consists of snippets from the
<code><a href="../reference/summarizeCovs.html">NMsim::summarizeCovs()</a></code> function. The code is not intended
to be used on its own.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">### use only simulated samples</span></span>
<span><span class="va">simres</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/data.table/man/as.data.table.html" class="external-link">as.data.table</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span><span class="op">[</span><span class="va">EVID</span><span class="op">==</span><span class="fl">2</span><span class="op">]</span></span>
<span></span>
<span></span>
<span><span class="co">### summarizing exposure metrics for each subject in each model,</span></span>
<span><span class="co">### each combination of covariates</span></span>
<span><span class="va">resp.model</span> <span class="op">&lt;-</span> <span class="va">simres</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">funs.exposure</span>,<span class="kw">function</span><span class="op">(</span><span class="va">f</span><span class="op">)</span><span class="fu">f</span><span class="op">(</span><span class="va">.SD</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                     by<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">allby</span>,<span class="va">modelby</span>,<span class="st">"ID"</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span><span class="co">### the exposure metrics in long format.</span></span>
<span><span class="va">mvars</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">funs.exposure</span><span class="op">)</span></span>
<span><span class="va">resp.model.l</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/data.table/man/melt.data.table.html" class="external-link">melt</a></span><span class="op">(</span><span class="va">resp.model</span>,measure.vars<span class="op">=</span><span class="va">mvars</span>,variable.name<span class="op">=</span><span class="st">"metric.var"</span>,value.name<span class="op">=</span><span class="st">"metric.val"</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co">## deriving median by model and time to have a single value per</span></span>
<span><span class="co">## model This is only relevant in case multiple subjects are</span></span>
<span><span class="co">## simulated by each model. </span></span>
<span><span class="va">sum.res.model</span> <span class="op">&lt;-</span> <span class="va">resp.model.l</span><span class="op">[</span></span>
<span>   ,<span class="fu">.</span><span class="op">(</span>predm<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/stats/median.html" class="external-link">median</a></span><span class="op">(</span><span class="va">metric.val</span><span class="op">)</span><span class="op">)</span></span>
<span>   ,by<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">modelby</span>,<span class="va">allby</span>,<span class="st">"metric.var"</span><span class="op">)</span></span>
<span><span class="op">]</span></span>
<span></span>
<span><span class="co">### making reference value a column rather than rows. </span></span>
<span><span class="co">## column with refrence exposure value is called val.exp.ref</span></span>
<span></span>
<span><span class="co">### summarize distribution of ratio to ref across parameter samples/models</span></span>
<span><span class="va">sum.uncertain</span> <span class="op">&lt;-</span> <span class="va">sum.res.model</span><span class="op">[</span></span>
<span>   ,<span class="fu"><a href="https://rdrr.io/r/stats/setNames.html" class="external-link">setNames</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">as.list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">predm</span><span class="op">/</span><span class="va">val.exp.ref</span>,probs<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">(</span><span class="fl">1</span><span class="op">-</span><span class="va">cover.ci</span><span class="op">)</span><span class="op">/</span><span class="fl">2</span>,<span class="fl">.5</span>,<span class="fl">1</span><span class="op">-</span><span class="op">(</span><span class="fl">1</span><span class="op">-</span><span class="va">cover.ci</span><span class="op">)</span><span class="op">/</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,</span>
<span>             <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"predml"</span>,<span class="st">"predmm"</span>,<span class="st">"predmu"</span><span class="op">)</span><span class="op">)</span></span>
<span>   ,by<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">allby</span>,<span class="st">"metric.var"</span><span class="op">)</span><span class="op">]</span></span></code></pre></div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Philip Delff.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>



  <script data-goatcounter="https://nmsim.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script>
</body>
</html>

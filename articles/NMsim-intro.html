<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>NMsim - Seamless NONMEM Simulation Platform in R • NMsim</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png">
<link rel="icon" type="”image/svg+xml”" href="../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../favicon.ico">
<link rel="manifest" href="../site.webmanifest">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<script src="../extra.js"></script><meta property="og:title" content="NMsim - Seamless NONMEM Simulation Platform in R">
<meta name="google-site-verification" content="1z2VLiQgr7hTGMX0G9VbQ3MzwU_Q9WWRLpdXynhsg30">
</head>
<body>
<p>




  pkgdown/in-header.html

  

  </p>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">NMsim</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.2.5</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../index.html" title="Simulation of Nonmem models from R"><span class="fa fas fa-home fa-lg"></span></a></li>
<li class="nav-item"><a class="nav-link" href="../articles/NMsim-examples.html">Examples</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">News</a></li>
<li class="nav-item"><a class="nav-link" href="../articles/NMsim-publications.html">Publications</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/nmautoverse/NMsim/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">


<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>NMsim - Seamless NONMEM Simulation Platform in R</h1>
                        <h4 data-toc-skip class="author">Philip
Delff</h4>
                        
            <h4 data-toc-skip class="date">September 09, 2025 using
NMsim 0.2.5</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/nmautoverse/NMsim/blob/main/vignettes/NMsim-intro.Rmd" class="external-link"><code>vignettes/NMsim-intro.Rmd</code></a></small>
      <div class="d-none name"><code>NMsim-intro.Rmd</code></div>
    </div>

    
    
<style type="text/css">

body{
  font-size: 12pt;
}

h1.title {
  font-size: 24px;
  color: DarkRed;
  margin-top: 2em;
  margin-bottom: 1em;
}
h1 { /* Header 1 */
  font-size: 20px;
  color: DarkBlue;
}
h2 { /* Header 2 */
  margin-top: 1em;
  font-size: 20px;
  color: DarkBlue;
}
h3 { /* Header 3 */
  font-size: 18px;
  font-family: "Times New Roman", Times, serif;
  color: DarkBlue;
}
h4 { /* Header 4 */
  font-size: 16px;
  font-family: "Times New Roman", Times, serif;
  color: DarkBlue;
}
table.Rtable1 {
    font-size: 12px;
}

.superbigimage{
      overflow-x:scroll;
      white-space: nowrap;
  }

.superbigimage img{
     max-width: none;
  }
  
h4.author {
  font-weight:bold;
  font-style:italic;
  margin-top: 0em;
  margin-bottom: 1em;
}
h4.date {
  font-weight:bold;
  margin-top: 0em;
  margin-bottom: 5em;
}


/* -----------div tips------------- */

div.summary {
 padding: 1em;
 margin: 1em;
 padding-left: 50px;
 background-size: 30px;
 background-repeat: no-repeat;
 background-position: 10px 10px;
 min-height: 40px;
 font-size: 16px;
 color: #000000;
 background-color: #bed3ec;
 border: solid 5px #dfedff;
 /* background-image: url("Summary_ffffff.png"); */
}

div.data {
 padding: 1em;
 margin: 1em;
 padding-left: 50px;
 background-size: 30px;
 background-repeat: no-repeat;
 background-position: 10px 10px;
 min-height: 40px;
 font-size: 16px;
 color: #000000;
 background-color: #FAD07D;
 border: solid 5px #FFDE9C;
 /* background-image: url("Stats graph_ffffff.png"); */
}


/* ----------- code fold button ------------- */
.showopt {
  display:inline-block;
  width: 120px;
  height: 29px;
  text-align: center;
  font-weight:400;
  vertical-align: middle !important;
  float: right;
  font-family: sans-serif;
  border-radius: 8px;
  cursor: pointer;
  border-color: #adb1b8 #a2a6ac #8d9096;
  border-style: solid;
  box-shadow: rgba(255,255,255,.6) 0 1px 0 inset;
  background-image:none;
}

pre{
  width:100%;
}




</style>
<div class="section level2">
<h2 id="objectives">Objectives<a class="anchor" aria-label="anchor" href="#objectives"></a>
</h2>
<p>This introduction to NMsim aims at enabling NONMEM users to</p>
<ul>
<li>Configure NMsim to find your NONMEM installation</li>
<li>Set up a simulation data set and simulate a NONMEM model using that
data set</li>
<li>Simulate a typical subject</li>
<li>Simulate multiple models and compare them</li>
<li>Simulate observed or previously simulated subjects based on
emperical Bayes estimates (ETA’s)</li>
<li>Simulate multiple subjects with covariate sampling and generation of
prediction intervals</li>
</ul>
</div>
<div class="section level2">
<h2 id="configuration">Configuration<a class="anchor" aria-label="anchor" href="#configuration"></a>
</h2>
<p>NMsim must be configured with the path to the NONMEM executable. This
can be done for each <code><a href="../reference/NMsim.html">NMsim()</a></code> call using the
<code>path.nonmem</code> argument, but more easily it can be configured
globally the following way. Also including where NMsim will run NONMEM
and store intermediate files (<code>dir.sims</code>) and where to store
final results (<code>dir.res</code>).</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://nmautoverse.github.io/NMdata/" class="external-link">NMdata</a></span><span class="op">)</span></span>
<span><span class="co">## Point NMsim to your NONMEM exectuable - looks like this on linux/osx</span></span>
<span><span class="fu"><a href="https://nmautoverse.github.io/NMdata/reference/NMdataConf.html" class="external-link">NMdataConf</a></span><span class="op">(</span>path.nonmem <span class="op">=</span> <span class="st">"/opt/NONMEM/nm75/run/nmfe75"</span><span class="op">)</span></span>
<span><span class="co">## or on Windows, it could be</span></span>
<span><span class="fu"><a href="https://nmautoverse.github.io/NMdata/reference/NMdataConf.html" class="external-link">NMdataConf</a></span><span class="op">(</span>path.nonmem <span class="op">=</span> <span class="st">"c:/nm75g64/run/nmfe75.bat"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://nmautoverse.github.io/NMdata/reference/NMdataConf.html" class="external-link">NMdataConf</a></span><span class="op">(</span>dir.sims<span class="op">=</span><span class="st">"simtmp-intro"</span>, <span class="co">## location of sim tmp files</span></span>
<span>           dir.res<span class="op">=</span><span class="st">"simres-intro"</span><span class="op">)</span>  <span class="co">## location of sim results</span></span></code></pre></div>
<p>For more information on this and how to test the configuration, see
<a href="https://NMautoverse.github.io/NMsim/articles/NMsim-config.html" class="external-link"><code>NMsim-config.html</code></a>.</p>
</div>
<div class="section level2">
<h2 id="a-first-simulation-with-nmsim">A First Simulation with <code>NMsim()</code><a class="anchor" aria-label="anchor" href="#a-first-simulation-with-nmsim"></a>
</h2>
<p>When providing a simulation data set, the default
<code><a href="../reference/NMsim.html">NMsim()</a></code> behavior is to sample a new subject (ETA’s).</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## Point to the model to estimate</span></span>
<span><span class="va">file.mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"examples/nonmem/xgxr021.mod"</span>,</span>
<span>                        package<span class="op">=</span><span class="st">"NMsim"</span><span class="op">)</span></span>
<span><span class="co">## Easily create a muliple-dose simulation data set with a loading dose</span></span>
<span><span class="va">data.sim</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/NMcreateDoses.html">NMcreateDoses</a></span><span class="op">(</span>TIME<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">24</span><span class="op">)</span>,AMT<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">300</span>,<span class="fl">150</span><span class="op">)</span>,ADDL<span class="op">=</span><span class="fl">5</span>,II<span class="op">=</span><span class="fl">24</span>,CMT<span class="op">=</span><span class="fl">1</span><span class="op">)</span><span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="../reference/NMaddSamples.html">NMaddSamples</a></span><span class="op">(</span>TIME<span class="op">=</span><span class="fl">0</span><span class="op">:</span><span class="op">(</span><span class="fl">24</span><span class="op">*</span><span class="fl">7</span><span class="op">)</span>,CMT<span class="op">=</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="co">## Simulate</span></span>
<span><span class="va">simres</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/NMsim.html">NMsim</a></span><span class="op">(</span>file.mod<span class="op">=</span><span class="va">file.mod</span>,data<span class="op">=</span><span class="va">data.sim</span>,table.vars<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"PRED"</span>,<span class="st">"IPRED"</span>,<span class="st">"Y"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>The simulation input data set is a data.frame, and
<code><a href="../reference/NMsim.html">NMsim()</a></code> returns a data.frame. Plot of simulation results
(click to button show code):</p>
<div class="fold s">
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">datl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/as.data.table.html" class="external-link">as.data.table</a></span><span class="op">(</span><span class="va">simres</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/melt.data.table.html" class="external-link">melt</a></span><span class="op">(</span>measure.vars<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"PRED"</span>,<span class="st">"IPRED"</span>,<span class="st">"Y"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">plot1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">datl</span>,<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">TIME</span>,<span class="va">value</span>,colour<span class="op">=</span><span class="va">variable</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span>data<span class="op">=</span><span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="va">x</span><span class="op">[</span><span class="va">variable</span><span class="op">!=</span><span class="st">"Y"</span><span class="op">]</span><span class="op">)</span><span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>data<span class="op">=</span><span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="va">x</span><span class="op">[</span><span class="va">variable</span><span class="op">==</span><span class="st">"Y"</span><span class="op">]</span><span class="op">)</span><span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x<span class="op">=</span><span class="st">"Hours since first dose"</span>,y<span class="op">=</span><span class="st">"Concentration (ng/mL)"</span>,</span>
<span>         subtitle<span class="op">=</span><span class="st">"Simulation of one new subject."</span>,</span>
<span>         colour<span class="op">=</span><span class="st">""</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="figure" style="text-align: center">
<img src="NMsim-intro_files/figure-html/simple-sim-showplot-1.png" alt="`PRED`, `IPRED`, and `Y` (if defined in control stream) are easily obtained with NMsim." width="100%"><p class="caption">
<code>PRED</code>, <code>IPRED</code>, and <code>Y</code> (if defined in
control stream) are easily obtained with NMsim.
</p>
</div>
<p>Notice that for running a model simulation, no information about the
model is needed except for the control stream file path. The simulation
is based on evaluation of <code>PRED</code>, <code>IPRED</code>, and
optionally <code>Y</code>. Options exist for building more advanced
simulation models. The models shown here are based on data available in
the <a href="https://cran.r-project.org/package=xgxr" class="external-link"><code>xgxr</code></a>
package.</p>
<p>Here is a conceptual diagram of the NMsim() workflow.</p>
<pre class="text"><code>   file.mod: Existing file.mod (unmodified NONMEM control stream)
   data: A data.frame with simulation data
      │
      ▼
NMsim()
  │
  ├─► Creates simulation control stream in dir.sims/
  │        (Typical automatic modifications:
  │         adds $SIMULATION, comments out $ESTIMATION,
  │         modifies data sections)
  │
  ├─► Runs NONMEM in dir.sims/
  │        (raw NONMEM outputs: lst, tab, phi, etc.)
  │
  ├─► Copies/organizes results into dir.res/
  │        ..._MetaData.rds: Main results file for re-rereading results
  │        ..._ResultsData.fst: Compressed archive
  │
  └─► Reads results → returns to R

 Diagram of the NMsim() process. The user calls NMsim() on an existing control stream, typically developed for estimation and a simulation data set as a data.frame (NMsim will store as file for NONMEM). Simulatio results are returned to R.</code></pre>
<p>Before getting into details on how to create datasets and other
features, let’s nail down some properties of NMsim to avoid common
misconceptions. As you start to explore NMsim, remember:</p>
<ol style="list-style-type: decimal">
<li>NMsim automates simulation of Nonmem models. You never have to edit
the Nonmem control stream manually. The path to a control stream
(typically of an estimated model) is passed to NMsim, and NMsim will
then internally create a simulation control stream, execute it, and
return the results.<br>
</li>
<li>You should never save the simulation data set in a text file (like
csv or similar). Just pass the data.frame in the <code>data</code>
argument in <code><a href="../reference/NMsim.html">NMsim()</a></code>, and NMsim will handle and save the
data internally, including needed modifications to the simulation
control stream to use the provided data.<br>
</li>
<li>Re-read 1. This also means you never have to modify the control
stream to match your simulation data set. NMsim fully automates
this.<br>
</li>
<li>You do not have to manually read simulation output tables. NMsim()
reads those and returns them in a data.frame by default. When you do
<code>simres &lt;- NMsim(file.mod=my_file_path,data=my_df)</code>,
<code>simres</code> contains (the combination of) the output
table(s).<br>
</li>
<li>Re-read 1. You do not have to update the control stream with final
parameter estimates. Those are by default inserted for simulation by
<code><a href="../reference/NMsim.html">NMsim()</a></code>. <code><a href="../reference/NMsim.html">NMsim()</a></code> obtains them from the
<code>.ext</code> file associated with the provided control stream.</li>
</ol>
<details><summary>
List of NMsim Modifications to Control Stream
</summary><p>To illustrate what NMsim did to the provided control stream, the
following uses <code><a href="https://waldo.r-lib.org/reference/compare.html" class="external-link">waldo::compare()</a></code> to compare the provided
<code>file.mod</code> and the generated simulation control stream.
Notice that <code>$DATA</code> and <code>$INPUT</code> have been updated
to match the provided simulation input data, parameter sections (in this
case <code>THETA</code> and <code>OMEGA</code>) updated with final
parameter estimates. Estimation and covariance steps have been replaced
by a simulation step, and <code>$TABLE</code> modified to generate a new
output table.</p>
<pre><code><span><span class="co">## file.mod$INPUT vs simulation$INPUT</span></span>
<span><span class="co">## <span style="color: #BBBB00;">- "$INPUT ROW ID NOMTIME TIME EVID CMT AMT DV FLAG STUDY"</span></span></span>
<span><span class="co">## <span style="color: #BBBB00;">- "BLQ CYCLE DOSE PART PROFDAY PROFTIME WEIGHTB eff0"</span></span></span>
<span><span class="co">## <span style="color: #0000BB;">+ "$INPUT NMROW ID TIME EVID CMT AMT II ADDL DV MDV"</span></span></span>
<span><span class="co">## </span></span>
<span><span class="co">## file.mod$DATA vs simulation$DATA</span></span>
<span><span class="co">## <span style="color: #BBBB00;">- "$DATA     ../data/xgxr2.csv IGNORE=@ IGNORE=(FLAG.NE.0) IGNORE(DOSE.LT.30)"</span></span></span>
<span><span class="co">## <span style="color: #0000BB;">+ "$DATA NMsimData_xgxr021_noname.csv"</span></span></span>
<span><span class="co">## <span style="color: #0000BB;">+ "IGN=@"</span></span></span>
<span><span class="co">## </span></span>
<span><span class="co">##     file.mod$THETA                        | simulation$THETA                 </span></span>
<span><span class="co">## [1] <span style="color: #00BB00;">"$THETA  (0,1)             ; POPKA"</span>   - <span style="color: #00BB00;">"$THETA (0,2.16656)  ; POPKA"</span> [1]</span></span>
<span><span class="co">## [2] <span style="color: #00BB00;">"$THETA  (0,100)             ; POPV2"</span> - <span style="color: #00BB00;">"$THETA (0,75.7289)  ; POPV2"</span> [2]</span></span>
<span><span class="co">## [3] <span style="color: #00BB00;">"$THETA  (0,3)             ; POPCL"</span>   - <span style="color: #00BB00;">"$THETA (0,13.9777)  ; POPCL"</span> [3]</span></span>
<span><span class="co">## [4] <span style="color: #00BB00;">"$THETA  (0,50)             ; POPV3"</span>  - <span style="color: #00BB00;">"$THETA (0,150.06)   ; POPV3"</span> [4]</span></span>
<span><span class="co">## [5] <span style="color: #00BB00;">"$THETA  (0,.5)             ; TVQ"</span>    - <span style="color: #00BB00;">"$THETA (0,8.48651)  ; TVQ"</span>   [5]</span></span>
<span><span class="co">## </span></span>
<span><span class="co">##     file.mod$OMEGA           | simulation$OMEGA               </span></span>
<span><span class="co">## [1] <span style="color: #00BB00;">"$OMEGA 0 FIX  ; BSV KA"</span> - <span style="color: #00BB00;">"$OMEGA 0 FIX     ; BSV KA"</span> [1]</span></span>
<span><span class="co">## [2] <span style="color: #00BB00;">"$OMEGA 0.1   ; BSV V2"</span>  - <span style="color: #00BB00;">"$OMEGA 0.178666  ; BSV V2"</span> [2]</span></span>
<span><span class="co">## [3] <span style="color: #00BB00;">"$OMEGA 0.1  ; BSV CL"</span>   - <span style="color: #00BB00;">"$OMEGA 0.249779  ; BSV CL"</span> [3]</span></span>
<span><span class="co">## [4] <span style="color: #00BB00;">"$OMEGA 0 FIX ; BSV V3"</span>  - <span style="color: #00BB00;">"$OMEGA 0 FIX     ; BSV V3"</span> [4]</span></span>
<span><span class="co">## [5] <span style="color: #00BB00;">"$OMEGA 0 FIX  ; BSV Q"</span>  - <span style="color: #00BB00;">"$OMEGA 0 FIX     ; BSV Q"</span>  [5]</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## file.mod$TABLE vs simulation$TABLE</span></span>
<span><span class="co">## <span style="color: #BBBB00;">- "$TABLE TVKA TVV2 TVV3 TVCL KA V2 V3 CL Q PRED IPRED Y NOPRINT FILE=xgxr021_res.txt"</span></span></span>
<span><span class="co">## <span style="color: #0000BB;">+ "$TABLE NMROW PRED IPRED Y NOPRINT NOAPPEND ONEHEADERALL NOTITLE FORMAT=s1PE16.9 FILE=xgxr021_noname.tab"</span></span></span>
<span><span class="co">## </span></span>
<span><span class="co">## `file.mod$ESTIMATION` is <span style="color: #00BB00;">a character vector</span> ('$ESTIMATION METHOD=1 POSTHOC INTER MAXEVAL=9999 NSIG=2 SIGL=9', '            PRINT=10 NOABORT MSFO=xgxr021.msf')</span></span>
<span><span class="co">## `simulation$ESTIMATION` is <span style="color: #00BB00;">NULL</span></span></span>
<span><span class="co">## </span></span>
<span><span class="co">## `file.mod$SIMULATION` is <span style="color: #00BB00;">NULL</span></span></span>
<span><span class="co">## `simulation$SIMULATION` is <span style="color: #00BB00;">a character vector</span> ('$SIMULATION ONLYSIM (2134995937) ')</span></span></code></pre>
</details>
</div>
<div class="section level2">
<h2 id="simulation-data-sets">Simulation Data Sets<a class="anchor" aria-label="anchor" href="#simulation-data-sets"></a>
</h2>
<p>The input data is just a <code>data.frame</code>. NMsim will save the
data set and create</p>
<ul>
<li>It must contain at least the variables NONMEM will need to run the
model (typically <code>ID</code>, <code>CMT</code>, <code>AMT</code>,
etc. plus covariates)</li>
<li>It can contain character variables (automatically carried to
results)</li>
<li>Column order does not matter</li>
</ul>
<p>As long as those requirements are met, there are no requirements to
how the data sets are created. So if you already have a prefered way to
do this, that’s fine. NMsim provides convenient helper functions that
can optionally be used. <code><a href="../reference/NMcreateDoses.html">NMcreateDoses()</a></code> creates just the
dosing events, and <code><a href="../reference/NMaddSamples.html">NMaddSamples()</a></code> adds the sampling events.
By default, doses are indicated using <code>EVID=1</code> and samples by
<code>EVID=2</code>.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">doses</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/NMcreateDoses.html">NMcreateDoses</a></span><span class="op">(</span>TIME<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>,by<span class="op">=</span><span class="fl">24</span>,length.out<span class="op">=</span><span class="fl">7</span><span class="op">)</span>,</span>
<span>                        AMT<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">300</span>,<span class="fl">150</span><span class="op">)</span>,CMT<span class="op">=</span><span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<p><code><a href="../reference/NMcreateDoses.html">NMcreateDoses()</a></code> offers arguments matching the
NONMEM-specific variables such as <code>CMT</code>, <code>EVID</code>,
<code>ADDL</code>, <code>II</code>, <code>SS</code> and more. This
example uses <code>ADDL</code> and <code>II</code> to repeat the
maintenance dose. It is designed to offer convenient syntax for most
common dosing regimens.</p>
<div class="section level3">
<h3 id="adding-sampling-times">Adding Sampling Times<a class="anchor" aria-label="anchor" href="#adding-sampling-times"></a>
</h3>
<p>For adding sampling times to a set of doses and/or samples,
<code><a href="../reference/NMaddSamples.html">NMaddSamples()</a></code> provides a similarly flexible interface. It
accepts data.frames with covariates allowing for different sampling
schemes for different subject groups (say different dosing regimens),
and dosing times can be supplied relative to previous dosing times.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dat.sim</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/NMaddSamples.html">NMaddSamples</a></span><span class="op">(</span><span class="va">doses</span>,TIME<span class="op">=</span><span class="fl">0</span><span class="op">:</span><span class="op">(</span><span class="fl">24</span><span class="op">*</span><span class="fl">7</span><span class="op">)</span>,CMT<span class="op">=</span><span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<p><code><a href="../reference/NMaddSamples.html">NMaddSamples()</a></code> has many useful features, including a
<code>TAPD</code> argument for adding samples relative to previous
dosing time, adding sampling for multiple endpoints, and different
sampling times for different subgroups of subjects. See <a href="NMsim-DataCreate.html"><strong>Data Set Creation with
NMsim</strong></a> for more details on creation of data sets, including
use of <code><a href="../reference/NMcreateDoses.html">NMcreateDoses()</a></code> and <code><a href="../reference/NMaddSamples.html">NMaddSamples()</a></code> and
how to also add time after previous dose and more.</p>
</div>
<div class="section level3">
<h3 id="check-the-simulation-dataset">Check The Simulation Dataset<a class="anchor" aria-label="anchor" href="#check-the-simulation-dataset"></a>
</h3>
<p>A quick way to check for a lot of common issues in a NONMEM data set
is running <code><a href="https://nmautoverse.github.io/NMdata/reference/NMcheckData.html" class="external-link">NMcheckData()</a></code>:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://nmautoverse.github.io/NMdata/reference/NMcheckData.html" class="external-link">NMcheckData</a></span><span class="op">(</span><span class="va">dat.sim</span>,type.data<span class="op">=</span><span class="st">"sim"</span><span class="op">)</span></span></code></pre></div>
<p>It is also advised to plot the simulation data set. See <a href="NMsim-DataCreate.html">Creation of Simulation Data Sets</a> for
more details.</p>
</div>
</div>
<div class="section level2">
<h2 id="typical-subject-simulation">Typical Subject Simulation<a class="anchor" aria-label="anchor" href="#typical-subject-simulation"></a>
</h2>
<ul>
<li>A typical subject is a subject with all ETAs = 0</li>
<li>Covariates values are supplied using the simulation input data
set</li>
<li>
<code>typical=TRUE</code>: replace all <code>$OMEGA</code> values
with zeros</li>
</ul>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">simres.typ</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/NMsim.html">NMsim</a></span><span class="op">(</span>file.mod<span class="op">=</span><span class="va">file.mod</span>,data<span class="op">=</span><span class="va">data.sim</span>,</span>
<span>                    typical<span class="op">=</span><span class="cn">TRUE</span>,  <span class="co">## FIX all OMEGA's to zero</span></span>
<span>                    name.sim<span class="op">=</span><span class="st">"typical"</span>, <span class="co">## simulation name - included in output</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="simulate-multiple-models">Simulate Multiple Models<a class="anchor" aria-label="anchor" href="#simulate-multiple-models"></a>
</h2>
<p>Multiple models can be simulated using the same data set in one
function call by supplying more than one model in the
<code>file.mod</code> argument. The models can be simulated on multiple
data sets by submitting a list of data.frames in the <code>data</code>
argument. NMsim will return one data.frame with all the results for easy
post-processing.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">file2.mod</span> <span class="op">&lt;-</span> <span class="st">"models/xgxr114.mod"</span></span>
<span><span class="va">simres.typ2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/NMsim.html">NMsim</a></span><span class="op">(</span>file.mod<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"2 compartments"</span><span class="op">=</span><span class="va">file.mod</span>,</span>
<span>                                <span class="st">"1 compartment"</span><span class="op">=</span><span class="va">file2.mod</span><span class="op">)</span>,</span>
<span>                     data<span class="op">=</span><span class="va">data.sim</span>,</span>
<span>                     typical<span class="op">=</span><span class="cn">TRUE</span>, <span class="co">## FIX all OMEGA's to zero</span></span>
<span>                     table.vars<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"PRED"</span>,<span class="st">"IPRED"</span>,<span class="st">"Y"</span><span class="op">)</span></span>
<span>                     <span class="op">)</span></span>
<span><span class="co">## The "model" column is used to distinguish the two models</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">simres.typ2</span>,<span class="va">EVID</span><span class="op">==</span><span class="fl">2</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">TIME</span>,<span class="va">PRED</span>,colour<span class="op">=</span><span class="va">model</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="figure" style="text-align: center">
<img src="NMsim-intro_files/figure-html/two-models-1.png" alt="Simulation of multiple models and even multiple data sets is handled within one `NMsim()` call." width="100%"><p class="caption">
Simulation of multiple models and even multiple data sets is handled
within one <code><a href="../reference/NMsim.html">NMsim()</a></code> call.
</p>
</div>
</div>
<div class="section level2">
<h2 id="emperical-bayes-estimates-known-etas">Emperical Bayes’ Estimates (known ETAs)<a class="anchor" aria-label="anchor" href="#emperical-bayes-estimates-known-etas"></a>
</h2>
<p>Reusing ETA’s is enabled using the <code>NMsim_EBE</code> method.</p>
<ul>
<li>By default, automatically re-uses estimated individual ETAs</li>
<li>ID values in simulation data must match the ID values in the
estimation that you want to simulate</li>
<li>Other ETA sources (<code>.phi</code> files) can be specified</li>
<li>Does not simulate residual variability - see
<code><a href="../reference/addResVar.html">addResVar()</a></code> if needed</li>
<li>Remember: Covariates may be needed in data set to fully reproduce
the subjects’ parameters</li>
</ul>
<p>In the following, we use <code>table.vars</code> to specify variables
to output in NONMEM’s <code>$TABLE</code> section. In this case, we do
that to make sure we get <code>CL</code> and <code>V2</code>. But
generally, <code>table.vars</code> is very important to know as the very
first thing to do to speed up <code><a href="../reference/NMsim.html">NMsim()</a></code>. This is because
NONMEM often takes much longer writing the output table than it does
doing the actual simulation. So it is recommended to specify a slim
output table using something like
<code>table.vars=c("PRED","IPRED","Y")</code> and other variables you
may need from NONMEM. Notice <code>NMsim</code> knows how to combine
output table data with the simulation input data, so you do not need
variables like <code>ID</code> or <code>TIME</code> in
<code>table.vars</code>.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## this example uses the same sim data for all subjects</span></span>
<span><span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://nmautoverse.github.io/NMdata/reference/NMscanData.html" class="external-link">NMscanData</a></span><span class="op">(</span><span class="va">file.mod</span>,quiet<span class="op">=</span><span class="cn">T</span><span class="op">)</span></span>
<span><span class="va">ids</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">res</span><span class="op">$</span><span class="va">ID</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">]</span></span>
<span><span class="va">data.sim.ind</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/merge.html" class="external-link">merge</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">data.sim</span>,select<span class="op">=</span><span class="op">-</span><span class="va">ID</span><span class="op">)</span>,</span>
<span>                      <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>ID<span class="op">=</span><span class="va">ids</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/setorder.html" class="external-link">setorder</a></span><span class="op">(</span><span class="va">data.sim.ind</span>,<span class="va">ID</span>,<span class="va">TIME</span>,<span class="va">EVID</span><span class="op">)</span></span>
<span><span class="va">simres.ebe</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/NMsim.html">NMsim</a></span><span class="op">(</span><span class="va">file.mod</span>,</span>
<span>                    data<span class="op">=</span><span class="va">data.sim.ind</span>,</span>
<span>                    table.vars<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"CL"</span>,<span class="st">"V2"</span>,<span class="st">"IPRED"</span>,<span class="st">"PRED"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div class="figure" style="text-align: center">
<img src="NMsim-intro_files/figure-html/unnamed-chunk-6-1.png" alt="Individual parameters are confirmed to be identical in estimation results and simulation results" width="100%"><p class="caption">
Individual parameters are confirmed to be identical in estimation
results and simulation results
</p>
</div>
</div>
<div class="section level2">
<h2 id="prediction-intervals">Prediction Intervals<a class="anchor" aria-label="anchor" href="#prediction-intervals"></a>
</h2>
<p>New subjects can be simulated in multiple ways with NMsim.</p>
<ul>
<li>If the input data set contains multiple subjects, these subjects
will get separate random effects due to NONMEM
<code>$SIMULATION</code>
</li>
<li>The <code>subproblems</code> argument translates to the
<code>SUBPROBLEMS</code> NONMEM subroutine, replicating the simulation
the specified number of times with new seeds</li>
<li>The <code><a href="../reference/simPopEtas.html">simPopEtas()</a></code> function can generate a synthetic .phi
file with a simulated population that can be reused in future
<code><a href="../reference/NMsim.html">NMsim()</a></code> calls. This can be combined with simulation of
covariates in R, allowing reuse of the same subjects across multiple
simulations.</li>
</ul>
<p>In the following we use both of these approaches to simulate 1000 new
subjects. We use <code><a href="../reference/NMsim.html">NMsim()</a></code>’s <code>name.sim</code> argument
to distinguish the simulation in output data and simulation output
files.</p>
<ul>
<li>Simulate 1000 new subjects using <code>$SUBPROBLEMS</code>
</li>
</ul>
<div class="fold s">
<p>Notice the following reuses the input data set 1000 times, and a
column called <code>NMREP</code> will count the subproblem number in the
output.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tablevars</span><span class="op">=</span><span class="fu"><a href="https://nmautoverse.github.io/NMdata/reference/cc.html" class="external-link">cc</a></span><span class="op">(</span><span class="va">PRED</span>,<span class="va">IPRED</span>,<span class="va">Y</span><span class="op">)</span></span>
<span><span class="va">simres.subprob</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/NMsim.html">NMsim</a></span><span class="op">(</span>file.mod<span class="op">=</span><span class="va">file.mod</span>,</span>
<span>                        data<span class="op">=</span><span class="va">data.sim</span>,</span>
<span>                        name.sim<span class="op">=</span><span class="st">"Subproblems"</span>, <span class="co">## naming the simulation</span></span>
<span>                        subproblems<span class="op">=</span><span class="fl">1000</span>,  <span class="co">## Will become SUPROBLEMS=1000 in NONMEM</span></span>
<span>                        table.vars<span class="op">=</span><span class="va">tablevars</span>,</span>
<span>                        seed.R<span class="op">=</span><span class="fl">764</span>, <span class="co">## NMsim() will set the R seed for reproducibility</span></span>
<span>                        reuse.results<span class="op">=</span><span class="va">reuse.results</span></span>
<span>                        <span class="op">)</span></span></code></pre></div>
<p>To generate a prediction interval, this format is sufficient. If you
want to distinguish the subjects, you can update the <code>ID</code>
column to reflect unique combinations of <code>ID</code> and
<code>NMREP</code>. With <code>data.table</code>, this can be done this
way:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## data.table:</span></span>
<span><span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/as.data.table.html" class="external-link">as.data.table</a></span><span class="op">(</span><span class="va">simres.subprob</span><span class="op">)</span><span class="op">[</span>,<span class="va">ID</span><span class="op">:=</span><span class="va">.GRP</span>,by<span class="op">=</span><span class="fu">.</span><span class="op">(</span><span class="va">NMREP</span>,<span class="va">ID</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="co">## dplyr:</span></span>
<span><span class="va">simres.subprob</span> <span class="op">&lt;-</span> <span class="va">simres.subprob</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">group_by</span><span class="op">(</span><span class="va">NMREP</span>,<span class="va">ID</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">mutate</span><span class="op">(</span>ID <span class="op">=</span> <span class="fu">cur_group_id</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">ungroup</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>By the way, if you would like <code><a href="../reference/NMsim.html">NMsim()</a></code> to return
<code>data.table</code> objects, just run
<code>NMdataConf(as.fun="data.table")</code>. If you want tibbles, run
<code>NMdataConf(as.fun=tibble::as_tibble)</code>.</p>
</div>
<ul>
<li>Simulate 1000 new subjects with covariate sampling</li>
</ul>
<div class="fold s">
<p>The NMsim package provides a convenient funtion to sample covariates
from an existing data set. We have a simulation data set with only one
subject. We want to replicate that data set to create 1000 subjects with
covariates sampled with replacement from the analysis data set.
<code><a href="../reference/sampleCovs.html">sampleCovs()</a></code> does exactly that. Notice two important
features of <code><a href="../reference/sampleCovs.html">sampleCovs()</a></code>:</p>
<ul>
<li><p>It automatically makes sure to sample with equal probability from
all subjects, independently of how many data points they have in the
analysis set.</p></li>
<li><p>For a simulated subject, all covariates are sampled from the same
subject in the analysis set. This ensures preservaion of the correlation
of the covariates from the analysis set to the simulation.</p></li>
</ul>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## read the analysis data set from the model we are simulating from</span></span>
<span><span class="va">dt.covs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://nmautoverse.github.io/NMdata/reference/NMscanData.html" class="external-link">NMscanData</a></span><span class="op">(</span><span class="va">file.mod</span>,quiet<span class="op">=</span><span class="cn">T</span><span class="op">)</span></span>
<span><span class="co">## replicate the simulation data set (one subject) to create 1000</span></span>
<span><span class="co">## subjects with covariates "WEIGHTB" and "trtact" sampled from the</span></span>
<span><span class="co">## analysis set.</span></span>
<span><span class="va">data.sim.nsubjs</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sampleCovs.html">sampleCovs</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">data.sim</span>,data.covs<span class="op">=</span><span class="va">dt.covs</span>,</span>
<span>                              covs<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"WEIGHTB"</span>,<span class="st">"trtact"</span><span class="op">)</span>,</span>
<span>                              Nsubjs<span class="op">=</span><span class="fl">1000</span>,seed.R<span class="op">=</span><span class="fl">2372</span><span class="op">)</span></span>
<span><span class="co">## renaming trtact to shorter trt in this example</span></span>
<span><span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/setattr.html" class="external-link">setnames</a></span><span class="op">(</span><span class="va">data.sim.nsubjs</span>,<span class="st">"trtact"</span>,<span class="st">"trt"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## generate the population first, by simulating etas to use in the sim</span></span>
<span><span class="fu"><a href="../reference/simPopEtas.html">simPopEtas</a></span><span class="op">(</span>file.mod<span class="op">=</span><span class="va">file.mod</span>,N<span class="op">=</span><span class="fl">1000</span>,seed<span class="op">=</span><span class="fl">1231</span>,</span>
<span>           file.phi<span class="op">=</span><span class="st">"simres-intro/xgxr021_1000subjs.phi"</span><span class="op">)</span></span>
<span><span class="va">simres.datarep</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/NMsim.html">NMsim</a></span><span class="op">(</span>file.mod<span class="op">=</span><span class="va">file.mod</span>,</span>
<span>                        data<span class="op">=</span><span class="va">data.sim.nsubjs</span>,</span>
<span>                        name.sim<span class="op">=</span><span class="st">"Individual simulation data"</span>,</span>
<span>                        table.vars<span class="op">=</span><span class="va">tablevars</span>,</span>
<span>                        seed.nm<span class="op">=</span><span class="fl">103</span>,</span>
<span>                        method.sim<span class="op">=</span><span class="va">NMsim_EBE</span>,</span>
<span>                        file.phi<span class="op">=</span><span class="st">"simres-intro/xgxr021_1000subjs.phi"</span>,</span>
<span>                        reuse.results<span class="op">=</span><span class="va">reuse.results</span></span>
<span>                        <span class="op">)</span></span></code></pre></div>
</div>
<ul>
<li>Derive and plot 90% prediction intervals</li>
</ul>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## Collect and stack simulation results </span></span>
<span><span class="va">simres.newpops</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/as.data.table.html" class="external-link">as.data.table</a></span><span class="op">(</span><span class="va">simres.subprob</span><span class="op">)</span>,</span>
<span>                        <span class="va">simres.datarep</span>,fill<span class="op">=</span><span class="cn">T</span><span class="op">)</span><span class="op">[</span><span class="va">EVID</span><span class="op">==</span><span class="fl">2</span><span class="op">]</span></span>
<span></span>
<span><span class="co">## Derive prediction intervals - notice name.sim distincts results from the two methods</span></span>
<span><span class="va">simres.pi</span> <span class="op">&lt;-</span> <span class="va">simres.newpops</span><span class="op">[</span></span>
<span>   ,<span class="fu"><a href="https://rdrr.io/r/stats/setNames.html" class="external-link">setNames</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">as.list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">IPRED</span>,probs<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">.05</span>,<span class="fl">.5</span>,<span class="fl">.95</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,<span class="fu"><a href="https://nmautoverse.github.io/NMdata/reference/cc.html" class="external-link">cc</a></span><span class="op">(</span><span class="va">ll</span>,<span class="va">median</span>,<span class="va">ul</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    by<span class="op">=</span><span class="fu">.</span><span class="op">(</span><span class="va">name.sim</span>,<span class="va">trt</span>,<span class="va">TIME</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span><span class="va">label.pi</span> <span class="op">&lt;-</span> <span class="st">"90% Prediction interval"</span></span>
<span><span class="va">simres.pi</span><span class="op">$</span><span class="va">type</span> <span class="op">&lt;-</span> <span class="va">label.pi</span></span>
<span></span>
<span><span class="va">p.pi</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">simres.pi</span>,<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">TIME</span>,fill<span class="op">=</span><span class="va">type</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_ribbon</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>ymin<span class="op">=</span><span class="va">ll</span>,ymax<span class="op">=</span><span class="va">ul</span><span class="op">)</span>,alpha<span class="op">=</span><span class="fl">.4</span><span class="op">)</span><span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y<span class="op">=</span><span class="va">median</span>,linetype<span class="op">=</span><span class="st">"Median"</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_alpha_manual</a></span><span class="op">(</span>values<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/stats/setNames.html" class="external-link">setNames</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">.5</span><span class="op">)</span>,<span class="va">label.pi</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_linetype_manual</a></span><span class="op">(</span>values<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/stats/setNames.html" class="external-link">setNames</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>,<span class="st">"Median"</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">name.sim</span><span class="op">)</span><span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x<span class="op">=</span><span class="st">"Hours since first dose"</span>,y<span class="op">=</span><span class="st">"Concentration (ng/mL)"</span>,colour<span class="op">=</span><span class="st">""</span>,linetype<span class="op">=</span><span class="st">""</span><span class="op">)</span></span></code></pre></div>
<div class="figure" style="text-align: center">
<img src="NMsim-intro_files/figure-html/pred-inds-showplot-1.png" alt="Prediction intervals. New subjects can be simulated in multiple ways with NMsim. A simulated population can be reused across simulations." width="100%"><p class="caption">
Prediction intervals. New subjects can be simulated in multiple ways
with NMsim. A simulated population can be reused across simulations.
</p>
</div>
</div>
<div class="section level2">
<h2 id="read-previously-generated-simulations">Read Previously Generated Simulations<a class="anchor" aria-label="anchor" href="#read-previously-generated-simulations"></a>
</h2>
<p>There is no need to save simulation results because they are already
saved by <code>NMsim</code>. Instead, use arguments
<code>dir.sims</code>, <code>dir.res</code> and <code>name.sim</code> to
make sure to get a meaningful structure for the generated files. Then
read the results with <code><a href="../reference/NMreadSim.html">NMreadSim()</a></code>. To re-read the first
simulation we did in this article, we can do this:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">simres</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/NMreadSim.html">NMreadSim</a></span><span class="op">(</span><span class="st">"simres-intro/xgxr021_noname_MetaData.rds"</span><span class="op">)</span></span></code></pre></div>
<p>The folder and file names were constructed based on
<code>dir.res="simres-intro"</code> and because <code>name.sim</code>
was not provided for that first simulation, in which case “noname” is
used as a placeholder. In fact, if we look at the console output from
NMsim, it is telling us exactly that (look at the last line).</p>
<p>Click to show R console output from NMsim</p>
<div class="fold o">
<pre><code>&gt; simres &lt;- NMsim(file.mod=file.mod,data=data.sim)
Location(s) of intermediate files and Nonmem execution:
  simtmp-intro/xgxr021_noname
Location of final result files:
  simres-intro

* Writing simulation control stream(s) and simulation data set(s)
* Executing Nonmem job(s) 
Starting NMTRAN

(...)

Done with nonmem execution
* Collecting Nonmem results

Simulation results returned. Re-read them without re-simulating using:
  simres &lt;- NMreadSim("simres-intro/xgxr021_noname_MetaData.rds")
</code></pre>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Philip Delff.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>



  <script data-goatcounter="https://nmsim.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script>
</body>
</html>

<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Simulation with Modifications to Parameters and Model Code • NMsim</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png">
<link rel="icon" type="”image/svg+xml”" href="../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../favicon.ico">
<link rel="manifest" href="../site.webmanifest">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<script src="../extra.js"></script><meta property="og:title" content="Simulation with Modifications to Parameters and Model Code">
<meta name="google-site-verification" content="1z2VLiQgr7hTGMX0G9VbQ3MzwU_Q9WWRLpdXynhsg30">
</head>
<body>
<p>




  pkgdown/in-header.html

  

  </p>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">NMsim</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.2.5</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../index.html" title="Simulation of Nonmem models from R"><span class="fa fas fa-home fa-lg"></span></a></li>
<li class="nav-item"><a class="nav-link" href="../articles/NMsim-examples.html">Examples</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">News</a></li>
<li class="nav-item"><a class="nav-link" href="../articles/NMsim-publications.html">Publications</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/nmautoverse/NMsim/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">


<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Simulation with Modifications to Parameters and Model Code</h1>
                        <h4 data-toc-skip class="author">Simone Cassani,
Philip Delff</h4>
                        
            <h4 data-toc-skip class="date">September 09, 2025 using
NMsim 0.2.5</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/nmautoverse/NMsim/blob/main/vignettes/NMsim-modify-model.Rmd" class="external-link"><code>vignettes/NMsim-modify-model.Rmd</code></a></small>
      <div class="d-none name"><code>NMsim-modify-model.Rmd</code></div>
    </div>

    
    
<!-- <img src="../reference/figures/NMsimlogo.png" alt="Logo" style="width:200px; float:right;"> -->
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>The introduction examples and the other examples show how to perform
various types of simulations, such as typical subject simulations,
simulations of new subjects, simulation of known subjects, and
simulation with parameter uncertainty. As different as these simulations
may be, they are all simulations of a model, exactly as specified or
exactly as estimated. The examples in this document focus on how
modifications to the estimated model can be specified. As will be shown,
NMsim provides very flexible and easy-to-use methods to obtain such
modifications, all contained within the <code><a href="../reference/NMsim.html">NMsim()</a></code> interface
itself.</p>
</div>
<div class="section level2">
<h2 id="objectives">Objectives<a class="anchor" aria-label="anchor" href="#objectives"></a>
</h2>
<p>This document aims at enabling you to do the following tasks.</p>
<ul>
<li><p>Control whether and how to update parameter values according to
the final model parameter estimates using the <code>inits</code>
argument.</p></li>
<li><p>Modify model parameter values (<code>$THETA</code>,
<code>$OMEGA</code> and <code>SIGMA</code>) to specify values using the
<code>inits</code> argument</p></li>
<li><p>Use the <code>modify</code> argument to do custom manipulations
of any parts of the control stream before simulation.</p></li>
<li><p>Modify data exclusions/inclusions (<code>$IGNORE/$ACCEPT</code>)
using the <code>filters</code> argument.</p></li>
<li><p>Adjust <code>$SIZES</code> variables using the <code>sizes</code>
argument.</p></li>
</ul>
<!-- DONE --- Philip comments :
The examples are great. This is the "Objectives" section. So maybe before each question, say what is done, like: 
Modify KA: How is the conc-time profile.....? --><p>The examples described below use the <code>modify</code> argument to
modify the NONMEM control stream and to address the following
pharmacometric questions:</p>
<ul>
<li>Modify <code>KA</code>: How is the concentration-time profile
affected if switching formulation (reducing absorption rate) by a range
of fold-values?</li>
<li>Modify <code>F1</code> and <code>CL</code>: What is the expected
concentration-time profile in patients with a certain Drug-Drug
Interaction effect on clearance and bioavailability?</li>
<li>Add <code>ALAG</code>: How will a dose delay of different amounts of
time affect the predicted exposure?</li>
<li>Add AUC computation in control stream: How can we use NONMEM to
integrate AUC during model simulation leveraging the benefits of using a
sparse grid via <code>NMsim</code>?</li>
</ul>
<!-- DONE --- Philip comment: This wording can be clearer. Use nonmem to integrate AUC, with benefit that a sparse simulation grid can be used? --><!-- REMOVED # Variable Parameters --><!-- DONE Philip comment:
The first part of this section could be elaborated a little and be called "Introduction" and put before the "objectives". list.sections is not formatted the same way as modify.  --><!-- modify is a flexible interface that allows for modification of control stream sections before a simulation is performed. modify can be used to edit any section in a control stream but most commonly, this would be the $PK or $PRED section, or it could be $DES and $MODEL if needed. --><!-- Remember that data related sections like $INPUT, $DATA, and $TABLE are automatically handled by NMsim, and it should not be necessary to consider those. For the $TABLE section specifically, look at the `table.vars` and `table.options` arguments instead. --><!-- MOVED TO INMTRODUCTION :Sometimes we want to simulate with some modification to the estimated model. NMsim canmake such user-specified modifications to the model before simulating through the `modify` argument.
Notice, until NMsim 0.1.0, the `modify` argument was called `list.sections`. The helper functions `add` and `overwrite` were introduced with NMsim 0.1.3. Until then, custom modification functions had to be provided like described in the section "Edit control stream using customized functions." --><!-- # Configuration --><!-- DONE : Philip comment:
None of these configurations are specific to using the modify argument. In a prerequisites section, you can mention that the user may need to config a little (as described in te intro vignette) and then you can omit this section. --><!-- REFERENCED in INTRO and removed from here --- NMsim must be configured with the path to the NONMEM executable. This can be done for each `NMsim()` call using the `path.nonmem` argument, but more easily it can be configured globally the following way. Also including where NMsim will run NONMEM and store intermediate files (`dir.sims`) and where to store final results (`dir.res`). --><!-- ```{r,echo=TRUE,eval=FALSE} --><!-- library(NMdata) --><!-- library(NMsim) --><!-- ## Point NMsim to your NONMEM exectuable - looks like this on linux/osx --><!-- NMdataConf(path.nonmem = "/opt/NONMEM/nm75/run/nmfe75") --><!-- ## or on Windows, it could be --><!-- NMdataConf(path.nonmem = "c:/nm75g64/run/nmfe75.bat") --><!-- NMdataConf(dir.sims="simtmp-modify", ## location of sim tmp files --><!--            dir.res="simres-modify", --><!--            as.fun="data.table")  ## location of sim results --><!-- ``` --><div class="section level3">
<h3 id="prerequisites">Prerequisites<a class="anchor" aria-label="anchor" href="#prerequisites"></a>
</h3>
<p>To reproduce the examples, you will need to have NMsim configured to
find your Nonmem installation. Also, you should be familiar with how to
use NMsim for running basic simulation workflows. If you need to revisit
those topics, please go to <a href="https://nmautoverse.github.io/NMsim/articles/NMsim-intro.html"><code>NMsim-intro.html</code></a>.
Especially, it will be helpful to be familiar with simple workflows with
NMsim to understand that certain “model mofifications” such as handling
data sections are done automatically by NMsim, and so methods described
in this document are unnecessary for those.</p>
</div>
<div class="section level3">
<h3 id="selecting-a-model-and-generating-simulation-data">Selecting a Model and Generating Simulation Data<a class="anchor" aria-label="anchor" href="#selecting-a-model-and-generating-simulation-data"></a>
</h3>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">file.mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"examples/nonmem/xgxr021.mod"</span>,</span>
<span>                        package<span class="op">=</span><span class="st">"NMsim"</span><span class="op">)</span></span>
<span><span class="va">data.sim</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/NMcreateDoses.html">NMcreateDoses</a></span><span class="op">(</span>TIME<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">24</span><span class="op">)</span>,AMT<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">300</span>,<span class="fl">150</span><span class="op">)</span>,ADDL<span class="op">=</span><span class="fl">5</span>,II<span class="op">=</span><span class="fl">24</span>,CMT<span class="op">=</span><span class="fl">1</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="../reference/NMaddSamples.html">NMaddSamples</a></span><span class="op">(</span>TIME<span class="op">=</span><span class="fl">0</span><span class="op">:</span><span class="op">(</span><span class="fl">24</span><span class="op">*</span><span class="fl">7</span><span class="op">)</span>,CMT<span class="op">=</span><span class="fl">2</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="edit-model-parameters-inits">Edit Model Parameters (<code>inits</code>)<a class="anchor" aria-label="anchor" href="#edit-model-parameters-inits"></a>
</h3>
<p>The <code>inits</code> argument is used to control the initial
values, or more accurately all the information in parameter sections of
the simulation control stream, such as <code>$THETA</code>,
<code>OMEGA</code>, <code>SIGMA</code>, and even priors if those are
used.</p>
<p>Before doing a simulation, we collect an overview of the parameters
in the estimated model, their initial values as specified in the control
stream, and the estimated values, as read from the <code>.ext</code>
file. We are using functions from NMdata to get these. If you are
interested in learning more about these functions, <a href="">This
NMdata vignette</a> is a good place to start.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">partab</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://nmautoverse.github.io/NMdata/reference/NMreadParsText.html" class="external-link">NMreadParsText</a></span><span class="op">(</span><span class="va">file.mod</span>,as.fun<span class="op">=</span><span class="st">"data.table"</span>,format<span class="op">=</span><span class="st">"%init;%symbol"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://nmautoverse.github.io/NMdata/reference/mergeCheck.html" class="external-link">mergeCheck</a></span><span class="op">(</span><span class="fu"><a href="https://nmautoverse.github.io/NMdata/reference/NMreadExt.html" class="external-link">NMreadExt</a></span><span class="op">(</span><span class="va">file.mod</span><span class="op">)</span>,by<span class="op">=</span><span class="st">"parameter"</span>,all.x<span class="op">=</span><span class="cn">TRUE</span>,common.cols<span class="op">=</span><span class="st">"drop.y"</span>,quiet<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">partab</span><span class="op">[</span>,<span class="fu">.</span><span class="op">(</span><span class="va">par.name</span>,<span class="va">symbol</span>,<span class="va">init</span>,<span class="va">est</span><span class="op">)</span><span class="op">]</span></span></code></pre></div>
<div class="kable-table">
<table class="table">
<thead><tr class="header">
<th align="left">par.name</th>
<th align="left">symbol</th>
<th align="left">init</th>
<th align="right">est</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">THETA(1)</td>
<td align="left">POPKA</td>
<td align="left">(0,1)</td>
<td align="right">2.1665600</td>
</tr>
<tr class="even">
<td align="left">THETA(2)</td>
<td align="left">POPV2</td>
<td align="left">(0,100)</td>
<td align="right">75.7289000</td>
</tr>
<tr class="odd">
<td align="left">THETA(3)</td>
<td align="left">POPCL</td>
<td align="left">(0,3)</td>
<td align="right">13.9777000</td>
</tr>
<tr class="even">
<td align="left">THETA(4)</td>
<td align="left">POPV3</td>
<td align="left">(0,50)</td>
<td align="right">150.0600000</td>
</tr>
<tr class="odd">
<td align="left">THETA(5)</td>
<td align="left">TVQ</td>
<td align="left">(0,.5)</td>
<td align="right">8.4865100</td>
</tr>
<tr class="even">
<td align="left">OMEGA(1,1)</td>
<td align="left">BSV KA</td>
<td align="left">0 FIX</td>
<td align="right">0.0000000</td>
</tr>
<tr class="odd">
<td align="left">OMEGA(2,2)</td>
<td align="left">BSV V2</td>
<td align="left">0.1</td>
<td align="right">0.1786660</td>
</tr>
<tr class="even">
<td align="left">OMEGA(3,3)</td>
<td align="left">BSV CL</td>
<td align="left">0.1</td>
<td align="right">0.2497790</td>
</tr>
<tr class="odd">
<td align="left">OMEGA(4,4)</td>
<td align="left">BSV V3</td>
<td align="left">0 FIX</td>
<td align="right">0.0000000</td>
</tr>
<tr class="even">
<td align="left">OMEGA(5,5)</td>
<td align="left">BSV Q</td>
<td align="left">0 FIX</td>
<td align="right">0.0000000</td>
</tr>
<tr class="odd">
<td align="left">SIGMA(1,1)</td>
<td align="left">Prop Err</td>
<td align="left">0.1</td>
<td align="right">0.0822435</td>
</tr>
<tr class="even">
<td align="left">SIGMA(2,2)</td>
<td align="left">Add Err</td>
<td align="left">0 FIX</td>
<td align="right">0.0000000</td>
</tr>
</tbody>
</table>
</div>
<p>Let’s run a simple simulation without specifying
<code>inits</code>.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">simres</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/NMsim.html">NMsim</a></span><span class="op">(</span>file.mod<span class="op">=</span><span class="va">file.mod</span>,</span>
<span>                data<span class="op">=</span><span class="va">data.sim</span>,</span>
<span>                name.sim<span class="op">=</span><span class="st">"basic-sim"</span><span class="op">)</span></span></code></pre></div>
<p>The following compares the <code>$THETA</code>, <code>$OMEGA</code>,
and <code>$SIGMA</code> sections of the estimated and the simulated
control streams side-by-side. The values have been updated in the
simulation control stream (to the right) based on the <code>.ext</code>
file (compare to “init” and “est” columns in table above).</p>
<pre><code><span><span class="co">##     file.mod$THETA                        | simulation$THETA                 </span></span>
<span><span class="co">## [1] <span style="color: #00BB00;">"$THETA  (0,1)             ; POPKA"</span>   - <span style="color: #00BB00;">"$THETA (0,2.16656)  ; POPKA"</span> [1]</span></span>
<span><span class="co">## [2] <span style="color: #00BB00;">"$THETA  (0,100)             ; POPV2"</span> - <span style="color: #00BB00;">"$THETA (0,75.7289)  ; POPV2"</span> [2]</span></span>
<span><span class="co">## [3] <span style="color: #00BB00;">"$THETA  (0,3)             ; POPCL"</span>   - <span style="color: #00BB00;">"$THETA (0,13.9777)  ; POPCL"</span> [3]</span></span>
<span><span class="co">## [4] <span style="color: #00BB00;">"$THETA  (0,50)             ; POPV3"</span>  - <span style="color: #00BB00;">"$THETA (0,150.06)   ; POPV3"</span> [4]</span></span>
<span><span class="co">## [5] <span style="color: #00BB00;">"$THETA  (0,.5)             ; TVQ"</span>    - <span style="color: #00BB00;">"$THETA (0,8.48651)  ; TVQ"</span>   [5]</span></span>
<span><span class="co">## </span></span>
<span><span class="co">##     file.mod$OMEGA           | simulation$OMEGA               </span></span>
<span><span class="co">## [1] <span style="color: #00BB00;">"$OMEGA 0 FIX  ; BSV KA"</span> - <span style="color: #00BB00;">"$OMEGA 0 FIX     ; BSV KA"</span> [1]</span></span>
<span><span class="co">## [2] <span style="color: #00BB00;">"$OMEGA 0.1   ; BSV V2"</span>  - <span style="color: #00BB00;">"$OMEGA 0.178666  ; BSV V2"</span> [2]</span></span>
<span><span class="co">## [3] <span style="color: #00BB00;">"$OMEGA 0.1  ; BSV CL"</span>   - <span style="color: #00BB00;">"$OMEGA 0.249779  ; BSV CL"</span> [3]</span></span>
<span><span class="co">## [4] <span style="color: #00BB00;">"$OMEGA 0 FIX ; BSV V3"</span>  - <span style="color: #00BB00;">"$OMEGA 0 FIX     ; BSV V3"</span> [4]</span></span>
<span><span class="co">## [5] <span style="color: #00BB00;">"$OMEGA 0 FIX  ; BSV Q"</span>  - <span style="color: #00BB00;">"$OMEGA 0 FIX     ; BSV Q"</span>  [5]</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## `file.mod$SIGMA`:   <span style="color: #00BB00;">"$SIGMA 0.1  ; Prop Err"</span>       <span style="color: #00BB00;">"$SIGMA 0 FIX ; Add Err"</span>     </span></span>
<span><span class="co">## `simulation$SIGMA`: <span style="color: #00BB00;">"$SIGMA 0.0822435  ; Prop Err"</span> <span style="color: #00BB00;">"$SIGMA 0 FIX      ; Add Err"</span></span></span></code></pre>
<p>To simulate the model without updating the parameters based on final
model estimates, use <code>inits=list(method="none")</code>.</p>
<p>We may want to customly specify individual parameter values. Let’s
now do rerun the simulation adding some custom values for
<code>THETA(1)</code> and <code>OMEGA(3,3)</code>. Since we are not
using <code>inits=list(method="none")</code> all other parameter values
are updated with final estimates.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">simres.inits1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/NMsim.html">NMsim</a></span><span class="op">(</span>file.mod<span class="op">=</span><span class="va">file.mod</span>,</span>
<span>                       data<span class="op">=</span><span class="va">data.sim</span>,</span>
<span>                       inits<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="st">"theta(1)"</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>init<span class="op">=</span><span class="fl">0.54</span><span class="op">)</span></span>
<span>                                 ,<span class="st">"omega(3,3)"</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>init<span class="op">=</span><span class="fl">.5</span><span class="op">)</span></span>
<span>                                  <span class="op">)</span>,</span>
<span>                       name.sim<span class="op">=</span><span class="st">"inits1"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##     file.mod$THETA                        | simulation$THETA                 </span></span>
<span><span class="co">## [1] <span style="color: #00BB00;">"$THETA  (0,1)             ; POPKA"</span>   - <span style="color: #00BB00;">"$THETA (0,0.54)     ; POPKA"</span> [1]</span></span>
<span><span class="co">## [2] <span style="color: #00BB00;">"$THETA  (0,100)             ; POPV2"</span> - <span style="color: #00BB00;">"$THETA (0,75.7289)  ; POPV2"</span> [2]</span></span>
<span><span class="co">## [3] <span style="color: #00BB00;">"$THETA  (0,3)             ; POPCL"</span>   - <span style="color: #00BB00;">"$THETA (0,13.9777)  ; POPCL"</span> [3]</span></span>
<span><span class="co">## [4] <span style="color: #00BB00;">"$THETA  (0,50)             ; POPV3"</span>  - <span style="color: #00BB00;">"$THETA (0,150.06)   ; POPV3"</span> [4]</span></span>
<span><span class="co">## [5] <span style="color: #00BB00;">"$THETA  (0,.5)             ; TVQ"</span>    - <span style="color: #00BB00;">"$THETA (0,8.48651)  ; TVQ"</span>   [5]</span></span>
<span><span class="co">## </span></span>
<span><span class="co">##     file.mod$OMEGA           | simulation$OMEGA               </span></span>
<span><span class="co">## [1] <span style="color: #00BB00;">"$OMEGA 0 FIX  ; BSV KA"</span> - <span style="color: #00BB00;">"$OMEGA 0 FIX     ; BSV KA"</span> [1]</span></span>
<span><span class="co">## [2] <span style="color: #00BB00;">"$OMEGA 0.1   ; BSV V2"</span>  - <span style="color: #00BB00;">"$OMEGA 0.178666  ; BSV V2"</span> [2]</span></span>
<span><span class="co">## [3] <span style="color: #00BB00;">"$OMEGA 0.1  ; BSV CL"</span>   - <span style="color: #00BB00;">"$OMEGA 0.5       ; BSV CL"</span> [3]</span></span>
<span><span class="co">## [4] <span style="color: #00BB00;">"$OMEGA 0 FIX ; BSV V3"</span>  - <span style="color: #00BB00;">"$OMEGA 0 FIX     ; BSV V3"</span> [4]</span></span>
<span><span class="co">## [5] <span style="color: #00BB00;">"$OMEGA 0 FIX  ; BSV Q"</span>  - <span style="color: #00BB00;">"$OMEGA 0 FIX     ; BSV Q"</span>  [5]</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## `file.mod$SIGMA`:   <span style="color: #00BB00;">"$SIGMA 0.1  ; Prop Err"</span>       <span style="color: #00BB00;">"$SIGMA 0 FIX ; Add Err"</span>     </span></span>
<span><span class="co">## `simulation$SIGMA`: <span style="color: #00BB00;">"$SIGMA 0.0822435  ; Prop Err"</span> <span style="color: #00BB00;">"$SIGMA 0 FIX      ; Add Err"</span></span></span></code></pre>
<p>For simulation purposes, the initial value is probably going to be
the only property of a parameter that needs to be controlled. For other
purposes like estimation or optimal sampling, properties such as “FIX”,
lower and upper limits may also need to be modified. <code>inits</code>
supports modification of any subset of these values. This would remove
“FIX” and include bounds like <code>(0,0.54,10)</code>:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">simres.inits1b</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/NMsim.html">NMsim</a></span><span class="op">(</span>file.mod<span class="op">=</span><span class="va">file.mod</span>,</span>
<span>                        data<span class="op">=</span><span class="va">data.sim</span>,</span>
<span>                        inits<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="st">"theta(1)"</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>init<span class="op">=</span><span class="fl">0.54</span>,lower<span class="op">=</span><span class="fl">0</span>,upper<span class="op">=</span><span class="fl">10</span>,FIX<span class="op">=</span><span class="fl">0</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                        name.sim<span class="op">=</span><span class="st">"inits1b"</span><span class="op">)</span></span></code></pre></div>
<p>The <code>inits</code> argument provides multiple interfaces to
specification of parameter values. The one used above is simple and easy
for a few parameter specifications. You can also maintain a
<code>data.frame</code> of parameters using (any subset of) columns
named <code>init</code>, <code>FIX</code>, <code>lower</code>,
<code>upper</code>. This may be more convenient for programming. Pass
this as</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">inits</span><span class="op">=</span><span class="fu">lists</span><span class="op">(</span>inits.tab<span class="op">=</span><span class="va">my.df</span><span class="op">)</span></span></code></pre></div>
<p>Also, you can use a specific format table used to represent parameter
values, as obtained by <code><a href="https://nmautoverse.github.io/NMdata/reference/NMreadExt.html" class="external-link">NMdata::NMreadExt()</a></code>. Read the
parameters, modify, apply (here, adding 30% to
<code>THETA(1)</code>):</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">myext</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://nmautoverse.github.io/NMdata/reference/NMreadExt.html" class="external-link">NMreadExt</a></span><span class="op">(</span><span class="va">file.mod</span><span class="op">)</span></span>
<span><span class="va">myext</span><span class="op">[</span><span class="va">myext</span><span class="op">$</span><span class="va">parameter</span><span class="op">==</span><span class="st">"THETA(1)"</span>,value<span class="op">=</span><span class="va">value</span><span class="op">*</span><span class="fl">1.3</span><span class="op">]</span></span>
<span></span>
<span><span class="va">simres.inits1c</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/NMsim.html">NMsim</a></span><span class="op">(</span>file.mod<span class="op">=</span><span class="va">file.mod</span>,</span>
<span>                        data<span class="op">=</span><span class="va">data.sim</span>,</span>
<span>                        inits<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>ext<span class="op">=</span><span class="va">myext</span><span class="op">)</span>,</span>
<span>                        name.sim<span class="op">=</span><span class="st">"inits1c"</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="edit-the-control-stream-text-modify">Edit the Control Stream Text (<code>modify</code>)<a class="anchor" aria-label="anchor" href="#edit-the-control-stream-text-modify"></a>
</h2>
<p>While <code>inits</code> modifies parameter values (and other
parameter properties), <code>modify</code> edits the control stream text
directly. This is a powerful alternative because it can allow for
modifications independent of parameter numbering, and the model can be
modified very freely.</p>
<!-- ## Modify Parameter Values by Editing the `$PK` Section -->
<div class="section level3">
<h3 id="example-modify-change-in-formulation">Example (<code>modify</code>): Change in formulation<a class="anchor" aria-label="anchor" href="#example-modify-change-in-formulation"></a>
</h3>
<p>This example edits the <code>$PK</code> section of an estimated
Nonmem model to adjust the model variable <code>KA</code>. Imagine we
are considering a new formulation, and we want to simulate how a
four-fold faster absorption would impact exposure. A simple way to do
that is to add a line <code>KA=KA/4</code> to the <code>$PK</code>
section. Easy:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">simres.ka4</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/NMsim.html">NMsim</a></span><span class="op">(</span>file.mod<span class="op">=</span><span class="va">file.mod</span>,</span>
<span>                    data<span class="op">=</span><span class="va">data.sim</span>,</span>
<span>                    name.sim<span class="op">=</span><span class="st">"sim-ka4"</span>,</span>
<span>                    modify<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>PK<span class="op">=</span><span class="fu">NMsim</span><span class="fu">::</span><span class="fu"><a href="../reference/add.html">add</a></span><span class="op">(</span><span class="st">"KA=KA/4"</span><span class="op">)</span><span class="op">)</span></span>
<span>                    <span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">simres.ka4</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/NMreadSim.html">NMreadSim</a></span><span class="op">(</span><span class="st">"simres-modify/xgxr021_simka4_MetaData.rds"</span><span class="op">)</span></span></code></pre></div>
<p>Notice how the difference from the original simulation is that the
control stream has a new line in <code>$PK</code> reading exactly
<code>KA=KA/4</code>. This method works on the PK section alone and is
independent of what <code>THETA</code> and <code>OMEGA</code> parameters
are related to <code>KA</code>.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">my.file.diff</span><span class="op">(</span><span class="fu"><a href="../reference/modTab.html">modTab</a></span><span class="op">(</span><span class="va">simres</span><span class="op">)</span><span class="op">$</span><span class="va">path.sim</span>,</span>
<span>             <span class="fu"><a href="../reference/modTab.html">modTab</a></span><span class="op">(</span><span class="va">simres.ka4</span><span class="op">)</span><span class="op">$</span><span class="va">path.sim</span>,sections<span class="op">=</span><span class="st">"PK"</span>,</span>
<span>             x_arg<span class="op">=</span><span class="st">"basic-sim"</span>,y_arg<span class="op">=</span><span class="st">"sim-ka4"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##      basic-sim$PK          | sim-ka4$PK                </span></span>
<span><span class="co">## [10] <span style="color: #555555;">"V3=TVV3*EXP(ETA(4))"</span> | <span style="color: #555555;">"V3=TVV3*EXP(ETA(4))"</span> [10]</span></span>
<span><span class="co">## [11] <span style="color: #555555;">"Q=TVQ*EXP(ETA(5))"</span>   | <span style="color: #555555;">"Q=TVQ*EXP(ETA(5))"</span>   [11]</span></span>
<span><span class="co">## [12] <span style="color: #555555;">"S2=V2"</span>               | <span style="color: #555555;">"S2=V2"</span>               [12]</span></span>
<span><span class="co">##                            - <span style="color: #0000BB;">"KA=KA/4"</span>             [13]</span></span></code></pre>
<p>The <code>modify</code> argument takes a list, where each element is
named as the control stream section to be modified, in this case
<code>$PK</code>. It can be - A character vector: the entire secion is
overwritten - A function: The function is applied to the section
text</p>
<p>In this case we used a function provided by NMsim called
<code><a href="../reference/add.html">add()</a></code>. This function actually returns a function which is a
little complicated but serves the purpose of this example. The function
it returns appends <code>KA=KA/4</code> to whatever character vector it
receives. It would be equivalent to do</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">simres.ka4</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/NMsim.html">NMsim</a></span><span class="op">(</span>file.mod<span class="op">=</span><span class="va">file.mod</span>,</span>
<span>                    data<span class="op">=</span><span class="va">data.sim</span>,</span>
<span>                    name.sim<span class="op">=</span><span class="st">"sim-ka4"</span>,</span>
<span>                    <span class="co">## equivalent to</span></span>
<span>                    <span class="co">## modify=list(PK=NMsim::add("KA=KA/4"))</span></span>
<span>                    modify<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>PK<span class="op">=</span><span class="kw">function</span><span class="op">(</span><span class="va">...</span><span class="op">)</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">...</span>,<span class="st">"KA=KA/4"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>                    <span class="op">)</span></span></code></pre></div>
<p><code><a href="../reference/add.html">NMsim::add()</a></code> may be a little easier to write and read.
It can also prepend text, see the <code>pos</code> argument. There is
also a function called <code><a href="../reference/overwrite.html">NMsim::overwrite()</a></code> which can replace
text strings. Once you try this one or two times, you will hopefully
appreciate how easily you can tweak control streams to do what you need,
still benifiting from <code><a href="../reference/NMsim.html">NMsim()</a></code>’s handling of data, automated
control stream generation etc.</p>
<p>Let’s compare the two simulation results. The absorption was slowed
as expected.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">simres</span>,<span class="va">simres.ka4</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">TIME</span>,<span class="va">PRED</span>,colour<span class="op">=</span><span class="va">name.sim</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="NMsim-modify-model_files/figure-html/unnamed-chunk-12-1.png" width="100%" style="display: block; margin: auto;"></p>
<!-- Philip comment:
I wrote the following as I was going through the doc. After having read the DDI example too, I actually really like this. But maybe in the intro and/or the first line of the examples, we should add what this illustrates in terms of NMsim features. 
The section title can be improved to match the learning objective. I agree its good to "flavor" with interpretation and communicate potential uses of these features. But I'd suggest to move that into the text.
Suggest: "Modify parameter values by editing the $PK section"-->
</div>
<div class="section level3">
<h3 id="controlling-variables-using-the-simulation-data-set">Controlling Variables Using The Simulation Data Set<a class="anchor" aria-label="anchor" href="#controlling-variables-using-the-simulation-data-set"></a>
</h3>
<p>In the previous example <code>KA</code> was scaled by 4 by
specicification in the <code><a href="../reference/NMsim.html">NMsim()</a></code> call. The following example
uses a column in the simulation data set to scale the <code>KA</code>
value. This allows for a more flexible exploration of the effect of
different values of <code>KA</code>.</p>
<p>The effect on the concentration-time profile of a change in
formulation that reduces absorption rate <code>KA</code> is explored
with the use of a scaling factor <code>KASCALE</code> included to the
NONMEM control stream via the <code>modify</code> argument. The values
of <code>KASCALE</code> are provided through the <code>NMsim</code>
simulation data <code>dat.sim.varka</code> containing dosing events. We
simulate three distinct subjects, each with their own
<code>KASCALE</code> value. <code>KASCALE</code> values 1, 4, and 10 are
used, corresponding to an unchanged KA, a 4-fold, and a 10-fold larger
KA. We will be looking at <code>PRED</code> (of concentrations) so this
is effectively a typical subject analysis.</p>
<p>First <code>KASCALE</code> is added to the simulation data by
repeating the data set three for each value of <code>KASCALE</code>, and
redefining <code>ID</code> to be distinct for each value of
<code>KASCALE</code>. The code below uses <code>data.table</code> but
any data manipulation tool (such as base R or dplyr) could be used.</p>
<!-- Philip comment: remove unused code -->
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># add KASCALE and copy patient info for each value of KASCALE</span></span>
<span><span class="va">dat.sim.varka</span> <span class="op">&lt;-</span> <span class="va">data.sim</span><span class="op">[</span>,<span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/data.table.html" class="external-link">data.table</a></span><span class="op">(</span>KASCALE<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">4</span>,<span class="fl">10</span><span class="op">)</span><span class="op">)</span>,by<span class="op">=</span><span class="va">data.sim</span><span class="op">]</span> </span>
<span><span class="va">dat.sim.varka</span><span class="op">[</span>,<span class="va">ID</span><span class="op">:=</span><span class="va">.GRP</span>,by<span class="op">=</span><span class="fu">.</span><span class="op">(</span><span class="va">KASCALE</span>,<span class="va">ID</span><span class="op">)</span><span class="op">]</span> <span class="co"># update patient IDs</span></span>
<span><span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/setorder.html" class="external-link">setorder</a></span><span class="op">(</span><span class="va">dat.sim.varka</span>,<span class="va">ID</span>,<span class="va">TIME</span>,<span class="va">EVID</span><span class="op">)</span> <span class="co"># order rows</span></span></code></pre></div>
<p>Then the <code><a href="../reference/NMsim.html">NMsim()</a></code> function is used to run the simulation
in which the <code>modify</code> argument is used to simulate a modified
model with different absorption rates, scaled by the parameter
<code>KASCALE</code>. Two different approaches are demonstrated:</p>
<ol style="list-style-type: lower-alpha">
<li>the effect of the scaling factor <code>KASCALE</code> is added at
the end of the <code>PK</code> section in the NONMEM control
stream.</li>
</ol>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">simres.varka</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/NMsim.html">NMsim</a></span><span class="op">(</span>file.mod<span class="op">=</span><span class="va">file.mod</span> <span class="co"># NONMEM control stream</span></span>
<span>                     ,data<span class="op">=</span><span class="va">dat.sim.varka</span> <span class="co"># simulation data file</span></span>
<span>                     <span class="co">## ,name.sim="varka"</span></span>
<span>                     ,name.sim<span class="op">=</span><span class="st">"add(): Append KA/KASCALE"</span></span>
<span>                     ,modify<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>PK<span class="op">=</span><span class="fu"><a href="../reference/add.html">add</a></span><span class="op">(</span><span class="st">"KA=KA/KASCALE"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<ol start="2" style="list-style-type: lower-alpha">
<li>the specific line that defines <code>TVKA</code> is modified to
include the effect of the scaling factor <code>KASCALE</code>. This is
done for illustration of <code>overwrite</code>, see the
<code>inits</code> argument for how to edit parameter values
directly.</li>
</ol>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">simres.varka2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/NMsim.html">NMsim</a></span><span class="op">(</span>file.mod<span class="op">=</span><span class="va">file.mod</span></span>
<span>                      ,data<span class="op">=</span><span class="va">dat.sim.varka</span></span>
<span>                       <span class="co">##,name.sim="varka2"</span></span>
<span>                      ,name.sim<span class="op">=</span><span class="st">"overwrite(): Replace THETA(1) by THETA(1)/KASCALE"</span></span>
<span>                      ,modify<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>PK<span class="op">=</span><span class="fu"><a href="../reference/overwrite.html">overwrite</a></span><span class="op">(</span><span class="st">"THETA(1)"</span>,<span class="st">"THETA(1)/KASCALE"</span><span class="op">)</span><span class="op">)</span></span>
<span>                       <span class="op">)</span></span></code></pre></div>
<p>The code below returns the plot</p>
<!-- Philip comment:
This is really nice. 
I suggest
- comment on the strengths and weaknesses of add and overwrite. I think typically, most users should use "add" because it's simpler. "add" is really simple but it can only patch after the rest of PK has already been processed. If something in PK is derived from the variables being modified, it will not work. "overwrite" is the CAS9 approach which can be very powerful and suffers from off-target risk. And also, the code needed may be more specific to a model. In this example, overwrite refers to THETA(1) which is model specific. add referring to KA only may be more generic. 
It would be very good to include some diffr() snippets to show what happened to the PK sections. If the PK section is simple, NMreadSection(sim.mod,section="PK") may be sufficient. sim.mod should be the generated simulation control streams. You may be able to run it on all of the control streams (the estimated, and the two simulated) at once, put it into a data.table, and show the control stream lines side by side as a table. -->
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">simres.both</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">simres.varka</span>,</span>
<span>                     <span class="va">simres.varka2</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">simres.both</span><span class="op">[</span><span class="va">EVID</span><span class="op">==</span><span class="fl">2</span><span class="op">]</span>,<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">TIME</span>,<span class="va">PRED</span>,colour<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">KASCALE</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>colour<span class="op">=</span><span class="st">"Fold absorption prolongation, KASCALE"</span><span class="op">)</span><span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_x_continuous</a></span><span class="op">(</span>breaks<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">168</span>,by<span class="op">=</span><span class="fl">24</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">name.sim</span><span class="op">)</span><span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_color_manual</a></span><span class="op">(</span>values<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"orange"</span>, <span class="st">"blue"</span>, <span class="st">"darkgreen"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="figure" style="text-align: center">
<img src="NMsim-modify-model_files/figure-html/varka-sim-plot-1.png" alt="Concentration (`PRED`) profile as a function of time computed by `NMsim` modified models **a** (left) and **b** (right). The equivalence and robustness of the two modified models is supported by the matching results, corresponding to reduced `PRED` values for higher values of `KASCALE` (lower absorption rate)." width="100%"><p class="caption">
Concentration (<code>PRED</code>) profile as a function of time computed
by <code>NMsim</code> modified models <strong>a</strong> (left) and
<strong>b</strong> (right). The equivalence and robustness of the two
modified models is supported by the matching results, corresponding to
reduced <code>PRED</code> values for higher values of
<code>KASCALE</code> (lower absorption rate).
</p>
</div>
</div>
</div>
<div class="section level2">
<h2 id="additional-modify-examples">Additional <code>modify</code> Examples<a class="anchor" aria-label="anchor" href="#additional-modify-examples"></a>
</h2>
<details><summary><code>modify</code> example: Drug-Drug Interaction (DDI)
</summary><p>The effect of DDI on clearance (<code>CL</code>) and bioavailability
(<code>F1</code>) is simulated for the following scenarios</p>
<table class="table">
<thead><tr class="header">
<th align="left">scenario</th>
<th align="left">CLSCALE</th>
<th align="left">FSCALE</th>
<th align="left">CLSCALE/FSCALE</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">noDDI</td>
<td align="left">1</td>
<td align="left">1</td>
<td align="left">1</td>
</tr>
<tr class="even">
<td align="left">DDI.1</td>
<td align="left">0.5</td>
<td align="left">1.2</td>
<td align="left">0.42</td>
</tr>
<tr class="odd">
<td align="left">DDI.2</td>
<td align="left">0.33</td>
<td align="left">1.1</td>
<td align="left">0.3</td>
</tr>
</tbody>
</table>
<p>First the <code>CL</code> and <code>F1</code> data is added to the
patient data</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## 'Outer join'</span></span>
<span><span class="va">dat.sim.DDI</span><span class="op">=</span><span class="va">data.sim</span><span class="op">[</span>,<span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/data.table.html" class="external-link">data.table</a></span><span class="op">(</span>CLSCALE<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">/</span><span class="fl">2</span>,<span class="fl">1</span><span class="op">/</span><span class="fl">3</span><span class="op">)</span></span>
<span>                                ,FSCALE<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1.2</span>,<span class="fl">1.1</span><span class="op">)</span></span>
<span>                                ,lab<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"noDDI"</span>,<span class="st">"DDI.1"</span>,<span class="st">"DDI.2"</span><span class="op">)</span><span class="op">)</span></span>
<span>                    ,by<span class="op">=</span><span class="va">data.sim</span><span class="op">]</span></span>
<span><span class="va">dat.sim.DDI</span><span class="op">[</span>,<span class="va">ID</span><span class="op">:=</span><span class="va">.GRP</span>,by<span class="op">=</span><span class="fu">.</span><span class="op">(</span><span class="va">lab</span>,<span class="va">ID</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/setorder.html" class="external-link">setorder</a></span><span class="op">(</span><span class="va">dat.sim.DDI</span>,<span class="va">ID</span>,<span class="va">TIME</span>,<span class="va">EVID</span><span class="op">)</span></span></code></pre></div>
<p>Then, the DDI driven change in parameters is added at the end of the
PK section of the NONMEM control stream via the <code>modify</code>
argument in the <code><a href="../reference/NMsim.html">NMsim()</a></code> function.</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">simres.DDI</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/NMsim.html">NMsim</a></span><span class="op">(</span>file.mod<span class="op">=</span><span class="va">file.mod</span></span>
<span>                   ,data<span class="op">=</span><span class="va">dat.sim.DDI</span></span>
<span>                   ,name.sim<span class="op">=</span><span class="st">"DDI"</span></span>
<span>                   ,modify<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>PK<span class="op">=</span><span class="fu"><a href="../reference/add.html">add</a></span><span class="op">(</span><span class="st">"CL=CL*CLSCALE"</span></span>
<span>                                      ,<span class="st">"F1=FSCALE"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>The effect on the concentration-time profile is shown in the figure
below</p>
<div class="figure" style="text-align: center">
<img src="NMsim-modify-model_files/figure-html/unnamed-chunk-21-1.png" alt="Concentration (`PRED`) profile as a function of time computed by `NMsim` modified model for different DDIs. The modified model correctly simulates (i) a higher value of `Cmax` on day 1 for higher biovalability; (ii) a higher `PRED` value  at steady state for lower apparent clearance effect `CLSCALE/FSCALE` values." width="100%"><p class="caption">
Concentration (<code>PRED</code>) profile as a function of time computed
by <code>NMsim</code> modified model for different DDIs. The modified
model correctly simulates (i) a higher value of <code>Cmax</code> on day
1 for higher biovalability; (ii) a higher <code>PRED</code> value at
steady state for lower apparent clearance effect
<code>CLSCALE/FSCALE</code> values.
</p>
</div>
<details><summary><code>modify</code> example: Conditional Dose Delay
</summary><!-- Philip comment: A little more intro would be useful. What are you simulating, and how are you doing that? The current wording aims at the ladder, but it is very technical - even I have to read it slowly to follow. --><!-- Philip comment: we should explain that we could set up different simulation data sets to obtain this. I mean by delaying the dose in the data set. But we are showing this to illustrate the flexibility of these features. In practice, many users might - with good reason - prefer to edit the time column in the sim data sets. --><p>Deviations in the administration schedule of a drug are simulated
including three parameters in the dataset: the dose number
<code>DOSCUMN</code>, obtained with <code><a href="https://nmautoverse.github.io/NMdata/reference/addTAPD.html" class="external-link">NMdata::addTAPD()</a></code>, the
specific number of the delayed dose <code>DELAYDOS</code> and the time
delay <code>ALAG</code>.</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dat.sim.alag</span> <span class="op">=</span> <span class="va">data.sim</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://nmautoverse.github.io/NMdata/reference/NMexpandDoses.html" class="external-link">NMexpandDoses</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://nmautoverse.github.io/NMdata/reference/addTAPD.html" class="external-link">addTAPD</a></span><span class="op">(</span><span class="op">)</span> <span class="co"># expand doses and add dose number</span></span>
<span><span class="va">dat.sim.alag</span><span class="op">[</span>,<span class="va">ROW</span><span class="op">:=</span><span class="va">.I</span><span class="op">]</span> <span class="co"># restore ROW with correct value</span></span>
<span>                                        <span class="co"># add delayed dose</span></span>
<span><span class="va">dat.sim.dos.delay</span><span class="op">=</span><span class="va">dat.sim.alag</span><span class="op">[</span>,<span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/data.table.html" class="external-link">data.table</a></span><span class="op">(</span>DELAYDOS<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>,<span class="fl">3</span>,<span class="fl">4</span>,<span class="fl">5</span>,<span class="fl">6</span>,<span class="fl">7</span><span class="op">)</span><span class="op">)</span></span>
<span>                              ,by<span class="op">=</span><span class="va">dat.sim.alag</span><span class="op">]</span></span>
<span>                                        <span class="co"># add dose delay </span></span>
<span><span class="va">dat.sim.alag.final</span><span class="op">=</span><span class="va">dat.sim.dos.delay</span><span class="op">[</span>,<span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/data.table.html" class="external-link">data.table</a></span><span class="op">(</span>ALAG<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">6</span>,<span class="fl">12</span>,<span class="fl">18</span>,<span class="fl">24</span><span class="op">)</span><span class="op">)</span></span>
<span>                                    ,by<span class="op">=</span><span class="va">dat.sim.dos.delay</span><span class="op">]</span></span>
<span>                                        <span class="co"># update ID </span></span>
<span><span class="va">dat.sim.alag.final</span><span class="op">[</span>,<span class="va">ID</span><span class="op">:=</span><span class="va">.GRP</span>,by<span class="op">=</span><span class="fu">.</span><span class="op">(</span><span class="va">ALAG</span>,<span class="va">DELAYDOS</span>,<span class="va">ID</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/setorder.html" class="external-link">setorder</a></span><span class="op">(</span><span class="va">dat.sim.alag.final</span>,<span class="va">ID</span>,<span class="va">TIME</span>,<span class="va">EVID</span><span class="op">)</span></span>
<span>                                        <span class="co">#dat.sim.alag.final = dat.sim.alag.final |&gt; fill(DOSCUMN)</span></span></code></pre></div>
<p>The following patient has a 6 hours delay to the administration of
dose 2.</p>
<table class="table">
<thead><tr class="header">
<th align="right">TIME</th>
<th align="right">AMT</th>
<th align="right">DOSCUMN</th>
<th align="right">DELAYDOS</th>
<th align="right">ALAG</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="right">0</td>
<td align="right">300</td>
<td align="right">1</td>
<td align="right">2</td>
<td align="right">6</td>
</tr>
<tr class="even">
<td align="right">24</td>
<td align="right">150</td>
<td align="right">2</td>
<td align="right">2</td>
<td align="right">6</td>
</tr>
<tr class="odd">
<td align="right">48</td>
<td align="right">150</td>
<td align="right">3</td>
<td align="right">2</td>
<td align="right">6</td>
</tr>
<tr class="even">
<td align="right">72</td>
<td align="right">150</td>
<td align="right">4</td>
<td align="right">2</td>
<td align="right">6</td>
</tr>
<tr class="odd">
<td align="right">96</td>
<td align="right">150</td>
<td align="right">5</td>
<td align="right">2</td>
<td align="right">6</td>
</tr>
<tr class="even">
<td align="right">120</td>
<td align="right">150</td>
<td align="right">6</td>
<td align="right">2</td>
<td align="right">6</td>
</tr>
<tr class="odd">
<td align="right">144</td>
<td align="right">150</td>
<td align="right">7</td>
<td align="right">2</td>
<td align="right">6</td>
</tr>
</tbody>
</table>
<p>The time delay is included in the modified control stream with
<code>NMsim</code> adding a single line at the end of the PK section,
where the dose delay on compartment 1 <code>ALAG1</code> is modified for
the dose with dose number <code>DOSCUMN</code> equal to the target
delayed dose number <code>DELAYDOS</code></p>
<!-- Philip comment: This explanation is easier to follow than the first one -->
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">simres.alag</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/NMsim.html">NMsim</a></span><span class="op">(</span>file.mod<span class="op">=</span><span class="va">file.mod</span></span>
<span>                    ,data<span class="op">=</span><span class="va">dat.sim.alag.final</span></span>
<span>                    ,name.sim<span class="op">=</span><span class="st">"alag"</span></span>
<span>                    ,modify<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>PK<span class="op">=</span></span>
<span>                                     <span class="fu"><a href="../reference/add.html">add</a></span><span class="op">(</span><span class="st">"IF(DOSCUMN.EQ.DELAYDOS) ALAG1=ALAG"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>The effect on concentration-time profiles and daily AUC are shown in
the two images below.</p>
<div class="figure" style="text-align: center">
<img src="NMsim-modify-model_files/figure-html/unnamed-chunk-26-1.png" alt="Effect of time delay (0, 12 and 24 hours on dose 2) on concentration (`PRED`) profile as a function of time computed by `NMsim` modified model. The implementation of the modified model simply consists of the addition of the variables `DOSCUMN`, `DELAYDOS`, and `ALAG` to the original data set, and the addition of one line of code to the PK section of the control stream via `modify`." width="100%"><p class="caption">
Effect of time delay (0, 12 and 24 hours on dose 2) on concentration
(<code>PRED</code>) profile as a function of time computed by
<code>NMsim</code> modified model. The implementation of the modified
model simply consists of the addition of the variables
<code>DOSCUMN</code>, <code>DELAYDOS</code>, and <code>ALAG</code> to
the original data set, and the addition of one line of code to the PK
section of the control stream via <code>modify</code>.
</p>
</div>
<!-- Philip comment: The AUC vs dose delay needs a little explanation. I think the intro to the dose delay example should explain we want to study the effect of delaying doses on predicted exposure. And then also just a sentence or two before this plot. -->
<!-- Philip comment would be good to include AUC/cmax derivation as folded code. -->
<div class="figure" style="text-align: center">
<img src="NMsim-modify-model_files/figure-html/unnamed-chunk-27-1.png" alt="Daily exposure on day 3 as a function of time delay for dose 2 (left) and dose 3 (right). The simulation results predict an increased risk for possible safety concerns (left panel, over-exposure) and loss of efficacy (right panel, under-exposure) as dose time delay gets larger." width="100%"><p class="caption">
Daily exposure on day 3 as a function of time delay for dose 2 (left)
and dose 3 (right). The simulation results predict an increased risk for
possible safety concerns (left panel, over-exposure) and loss of
efficacy (right panel, under-exposure) as dose time delay gets larger.
</p>
</div>
<details><summary><code>modify</code> example: Calculation of AUC
</summary><!-- Philip comment: A little more intro would be helpful. This is a more advanced example that modifies multiple sections. --><p>The following example computes daily exposure:</p>
<ul>
<li>at post-processing, using trapezoidal method, after the unmodified
NONMEM model is simulated on three different fine grids with evenly
spaced time steps of <code>0.25</code>, <code>1</code>, and
<code>4</code> hours, respectively, labelled <strong>AUC
trapez</strong>
</li>
</ul>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">file.mod.auc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"examples/nonmem/xgxr046.mod"</span>,</span>
<span>                            package<span class="op">=</span><span class="st">"NMsim"</span><span class="op">)</span></span>
<span><span class="va">data.sim.auc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://nmautoverse.github.io/NMdata/reference/NMreadCsv.html" class="external-link">NMreadCsv</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"examples/derived/dat_sim1.csv"</span>,</span>
<span>                                      package<span class="op">=</span><span class="st">"NMsim"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">data.sim.auc</span><span class="op">[</span>,<span class="va">AMT</span><span class="op">:=</span><span class="fl">1000</span><span class="op">*</span><span class="va">AMT</span><span class="op">]</span></span>
<span></span>
<span>                                        <span class="co"># time step 1hr</span></span>
<span><span class="va">data.sim.1hr</span><span class="op">=</span><span class="va">data.sim.auc</span></span>
<span><span class="va">data.sim.1hr</span><span class="op">[</span>,<span class="va">TSTEP</span><span class="op">:=</span><span class="st">"1hr"</span><span class="op">]</span></span>
<span></span>
<span>                                        <span class="co"># time step 0.25hr</span></span>
<span><span class="va">data.sim.0.25hr</span><span class="op">=</span><span class="fu"><a href="../reference/addEVID2.html">addEVID2</a></span><span class="op">(</span><span class="va">data.sim.auc</span><span class="op">[</span><span class="va">EVID</span><span class="op">==</span><span class="fl">1</span><span class="op">]</span>,CMT<span class="op">=</span><span class="fl">2</span>,time.sim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">192</span>,by<span class="op">=</span><span class="fl">0.25</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">data.sim.0.25hr</span><span class="op">[</span>,<span class="va">TSTEP</span><span class="op">:=</span><span class="st">"0.25hr"</span><span class="op">]</span></span>
<span></span>
<span>                                        <span class="co"># time step 4hr</span></span>
<span><span class="va">data.sim.4hr</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/addEVID2.html">addEVID2</a></span><span class="op">(</span><span class="va">data.sim.auc</span><span class="op">[</span><span class="va">EVID</span><span class="op">==</span><span class="fl">1</span><span class="op">]</span>,CMT<span class="op">=</span><span class="fl">2</span>,time.sim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">192</span>,by<span class="op">=</span><span class="fl">4</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">data.sim.4hr</span><span class="op">[</span>,<span class="va">TSTEP</span><span class="op">:=</span><span class="st">"4hr"</span><span class="op">]</span></span>
<span></span>
<span><span class="va">sres.trapez</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/NMsim.html">NMsim</a></span><span class="op">(</span>file.mod<span class="op">=</span><span class="va">file.mod.auc</span></span>
<span>                    ,data<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">data.sim.1hr</span> <span class="co"># run NMsim on a list of data sets to run all different scenarios at once</span></span>
<span>                              ,<span class="va">data.sim.0.25hr</span></span>
<span>                              ,<span class="va">data.sim.4hr</span><span class="op">)</span></span>
<span>                    ,seed<span class="op">=</span><span class="fl">12345</span></span>
<span>                    ,table.vars<span class="op">=</span><span class="fu"><a href="https://nmautoverse.github.io/NMdata/reference/cc.html" class="external-link">cc</a></span><span class="op">(</span><span class="va">PRED</span>,<span class="va">IPRED</span><span class="op">)</span></span>
<span>                    ,name.sim<span class="op">=</span><span class="st">"AUC.trapez"</span></span>
<span>                    ,reuse.results<span class="op">=</span><span class="va">reuse.results</span></span>
<span>                     <span class="op">)</span></span>
<span></span>
<span>                                        <span class="co"># daily AUC computation</span></span>
<span><span class="va">sim.auc</span><span class="op">=</span><span class="va">sres.trapez</span><span class="op">[</span><span class="va">EVID</span><span class="op">==</span><span class="fl">2</span>,<span class="fu">.</span><span class="op">(</span><span class="va">ID</span>,<span class="va">TIME</span>,<span class="va">PRED</span>,time.step<span class="op">=</span><span class="va">TSTEP</span><span class="op">)</span><span class="op">]</span> </span>
<span><span class="va">sim.auc</span><span class="op">[</span>,<span class="va">DAY</span><span class="op">:=</span><span class="op">(</span><span class="va">TIME</span><span class="op"><a href="https://rdrr.io/r/base/Arithmetic.html" class="external-link">%/%</a></span><span class="fl">24</span><span class="op">)</span><span class="op">+</span><span class="fl">1</span><span class="op">]</span> <span class="co"># define DAY variable</span></span>
<span>                                        <span class="co"># create duplicate time steps for end-of-day</span></span>
<span>                                        <span class="co"># (e.g 24h belongs to both day 1 and day2)</span></span>
<span><span class="va">sim.dupli.24h</span><span class="op">=</span><span class="va">sim.auc</span><span class="op">[</span><span class="va">TIME</span><span class="op"><a href="https://rdrr.io/r/base/Arithmetic.html" class="external-link">%%</a></span><span class="fl">24</span><span class="op">==</span><span class="fl">0</span> <span class="op">&amp;</span> <span class="va">TIME</span><span class="op">&gt;</span><span class="fl">0</span>,<span class="fu">.</span><span class="op">(</span><span class="va">ID</span></span>
<span>                                            ,DAY<span class="op">=</span><span class="va">DAY</span><span class="op">-</span><span class="fl">1</span></span>
<span>                                            ,<span class="va">TIME</span></span>
<span>                                            ,<span class="va">PRED</span></span>
<span>                                            ,<span class="va">time.step</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="va">sim.auc.final</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">sim.auc</span></span>
<span>                      ,<span class="va">sim.dupli.24h</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/setorder.html" class="external-link">setorder</a></span><span class="op">(</span><span class="va">ID</span>,<span class="va">DAY</span>,<span class="va">TIME</span>,<span class="va">time.step</span><span class="op">)</span></span>
<span></span>
<span><span class="va">sim.auc.trapez</span><span class="op">&lt;-</span><span class="va">sim.auc.final</span><span class="op">[</span><span class="va">DAY</span><span class="op">&lt;</span><span class="fl">8</span>,<span class="fu">.</span><span class="op">(</span>AUC<span class="op">=</span><span class="fu">NMcalc</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/NMcalc/man/trapez.html" class="external-link">trapez</a></span><span class="op">(</span><span class="va">TIME</span>,<span class="va">PRED</span><span class="op">)</span><span class="op">)</span></span>
<span>                             ,by<span class="op">=</span><span class="fu">.</span><span class="op">(</span><span class="va">ID</span>,<span class="va">DAY</span>,<span class="va">time.step</span><span class="op">)</span><span class="op">]</span></span>
<span>                                        <span class="co"># stmp=sres1[EVID==2,.(ID,TIME,PRED)]</span></span>
<span>                                        <span class="co"># stmp[,DAY:=(TIME%/%24)+1]</span></span>
<span>                                        <span class="co"># sAUC&lt;-stmp[,.(AUC=NMcalc::trapez(TIME,PRED)),by=.(ID,DAY)]</span></span></code></pre></div>
<ul>
<li>at run time, with an <code>NMsim</code> modified script, on a course
grid with evenly spaced time steps of <code>24</code> hours, labelled
<strong>AUC $DES</strong>. Of note, this task requires additions to the
control stream in multiple sections.</li>
</ul>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># AUC with NMsim -  time step 24hr</span></span>
<span><span class="va">data.sim2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/addEVID2.html">addEVID2</a></span><span class="op">(</span><span class="va">data.sim.auc</span><span class="op">[</span><span class="va">EVID</span><span class="op">==</span><span class="fl">1</span><span class="op">]</span>,CMT<span class="op">=</span><span class="fl">2</span>,time.sim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>,by<span class="op">=</span><span class="fl">24</span>,length.out<span class="op">=</span><span class="fl">9</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">sres.des</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/NMsim.html">NMsim</a></span><span class="op">(</span>file.mod<span class="op">=</span><span class="va">file.mod.auc</span></span>
<span>                 ,data<span class="op">=</span><span class="va">data.sim2</span></span>
<span>                 ,table.vars<span class="op">=</span><span class="fu"><a href="https://nmautoverse.github.io/NMdata/reference/cc.html" class="external-link">cc</a></span><span class="op">(</span><span class="va">PRED</span>,<span class="va">IPRED</span>,<span class="va">AUCNMSIM</span><span class="op">)</span></span>
<span>                 ,name.sim<span class="op">=</span><span class="st">"AUC.nmsim"</span></span>
<span>                 ,seed<span class="op">=</span><span class="fl">12345</span></span>
<span>                 ,reuse.results<span class="op">=</span><span class="va">reuse.results</span></span>
<span>                 ,modify<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>MODEL<span class="op">=</span><span class="fu"><a href="../reference/add.html">add</a></span><span class="op">(</span><span class="st">"COMP=(AUC)"</span><span class="op">)</span></span>
<span>                             ,DES<span class="op">=</span><span class="fu"><a href="../reference/add.html">add</a></span><span class="op">(</span><span class="st">"DADT(3)=A(2)/V2"</span><span class="op">)</span></span>
<span>                             ,ERROR<span class="op">=</span><span class="fu"><a href="../reference/add.html">add</a></span><span class="op">(</span><span class="st">"AUCCUM=A(3)"</span></span>
<span>                                       ,<span class="st">"IF(NEWIND.NE.2) OLDAUCCUM=0"</span></span>
<span>                                       ,<span class="st">"AUCNMSIM = AUCCUM-OLDAUCCUM"</span></span>
<span>                                       ,<span class="st">"OLDAUCCUM = AUCCUM"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">sres.des</span><span class="op">[</span>,<span class="va">DAY</span><span class="op">:=</span><span class="va">TIME</span><span class="op"><a href="https://rdrr.io/r/base/Arithmetic.html" class="external-link">%/%</a></span><span class="fl">24</span><span class="op">]</span></span>
<span><span class="va">sres.des</span><span class="op">[</span>,<span class="va">AUC.NMsim</span><span class="op">:=</span><span class="va">AUCNMSIM</span><span class="op">]</span></span>
<span><span class="va">sres.auc.des</span><span class="op">=</span><span class="va">sres.des</span><span class="op">[</span><span class="va">AUCNMSIM</span><span class="op">!=</span><span class="fl">0</span>,<span class="fu">.</span><span class="op">(</span><span class="va">TIME</span>,<span class="va">DAY</span>,<span class="va">PRED</span>,<span class="va">AUC.NMsim</span><span class="op">)</span><span class="op">]</span></span></code></pre></div>
<p>The plot comparing the <code>DES</code> and <code>trapez</code> AUC
is obtained with the code below</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sres.final</span><span class="op">=</span><span class="fu"><a href="https://nmautoverse.github.io/NMdata/reference/mergeCheck.html" class="external-link">mergeCheck</a></span><span class="op">(</span><span class="va">sim.auc.trapez</span><span class="op">[</span>,<span class="fu">.</span><span class="op">(</span><span class="va">DAY</span>,<span class="va">AUC</span>,<span class="va">time.step</span><span class="op">)</span><span class="op">]</span></span>
<span>                     ,<span class="va">sres.auc.des</span><span class="op">[</span>,<span class="fu">.</span><span class="op">(</span><span class="va">DAY</span>,<span class="va">AUC.NMsim</span><span class="op">)</span><span class="op">]</span></span>
<span>                     ,by<span class="op">=</span><span class="st">"DAY"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">sres.final</span>,<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">AUC.NMsim</span>,<span class="va">AUC</span>,colour<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">time.step</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>size<span class="op">=</span><span class="fl">4</span><span class="op">)</span><span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>colour<span class="op">=</span><span class="st">"Time step in fine grid"</span><span class="op">)</span><span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_color_manual</a></span><span class="op">(</span>values<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"orange"</span>, <span class="st">"blue"</span>, <span class="st">"darkgreen"</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html" class="external-link">xlim</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">17</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html" class="external-link">ylim</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">17</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"AUC 0-24h by trapez method, on fine grid"</span><span class="op">)</span><span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"AUC 0-24h by integration through $DES, on coarse grid"</span><span class="op">)</span><span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_abline</a></span><span class="op">(</span>slope<span class="op">=</span><span class="fl">1</span>, intercept<span class="op">=</span><span class="fl">0</span><span class="op">)</span></span></code></pre></div>
<div class="figure" style="text-align: center">
<img src="NMsim-modify-model_files/figure-html/unnamed-chunk-30-1.png" alt="Daily exposures computed at run time ($DES, coarse grid, x-axis) and post-processing time (`trapez`, fine grids, y-axis). AUC (trapez) converges to the value computed with $DES method as the time step is reduced. Includes identity line." width="100%"><p class="caption">
Daily exposures computed at run time ($DES, coarse grid, x-axis) and
post-processing time (<code>trapez</code>, fine grids, y-axis). AUC
(trapez) converges to the value computed with $DES method as the time
step is reduced. Includes identity line.
</p>
</div>
</details></details></details>
</div>
<div class="section level2">
<h2 id="modify-sizes-using-sizes">Modify <code>$SIZES</code> using <code>sizes</code><a class="anchor" aria-label="anchor" href="#modify-sizes-using-sizes"></a>
</h2>
<p>For some NONMEM runs (simulations) it may be necessary to modify
<code>$SIZES</code>. Remember that the simulation control stream is
derived based on the estimation control stream, and so if
<code>$SIZES</code> settings are found in the estimation control stream,
those will by default also be in the simulation control stream generated
by <code><a href="../reference/NMsim.html">NMsim()</a></code>. The <code>sizes</code> argument is hence only
needed if the simulation <code>$SIZES</code> variables need to be
different from those used during estimation. This will typically be the
case due to properties of the simulation data. <code><a href="../reference/NMsim.html">NMsim()</a></code> by
default calls NONMEM with options that should help guessing some of
these options automatically, but here is how to do it if that fails.</p>
<p><code>sizes</code> is very simple to use. As an example, this
<code><a href="../reference/NMsim.html">NMsim()</a></code> call sets <code>$SIZES PD=100 LTV=70</code></p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">simres</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/NMsim.html">NMsim</a></span><span class="op">(</span>file.mod<span class="op">=</span><span class="va">file.mod</span>,</span>
<span>                data<span class="op">=</span><span class="va">data.sim</span>,</span>
<span>                sizes<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>PD<span class="op">=</span><span class="fl">100</span>,LTV<span class="op">=</span><span class="fl">70</span><span class="op">)</span>,</span>
<span>                name.sim<span class="op">=</span><span class="st">"sim-sizes"</span><span class="op">)</span></span></code></pre></div>
<p><code>sizes</code> by default only overwrites matching
<code>$SIZES</code> variables. If <code>$SIZES</code> already contained
other variables than in this case <code>PD</code> and <code>LTV</code>,
those would be left untouched. If you want to write the
<code>$SIZES</code> section from scratch, add
<code>wipe=TRUE</code>:</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">simres</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/NMsim.html">NMsim</a></span><span class="op">(</span>file.mod<span class="op">=</span><span class="va">file.mod</span>,</span>
<span>                data<span class="op">=</span><span class="va">data.sim</span>,</span>
<span>                sizes<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>PD<span class="op">=</span><span class="fl">100</span>,LTV<span class="op">=</span><span class="fl">70</span>,wipe<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>                name.sim<span class="op">=</span><span class="st">"sim-sizes"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="modify-acceptignore-using-filters">Modify <code>ACCEPT</code>/<code>IGNORE</code> Using
<code>filters</code><a class="anchor" aria-label="anchor" href="#modify-acceptignore-using-filters"></a>
</h2>
<p>The <code>filters</code> argument is an interface to control the
<code>ACCEPT</code> and <code>IGNORE</code> (inclusion/exclusion)
statements in NONMEM. This can be but is rarely used for simulation
because the simulation data set is normally filtered for the simulation
purpose. The common exception is for simlation of VPC. To avoid
duplication of examples, please refer to</p>
<p><a href="NMsim-VPC.html#change-the-acceptignore-statements">VPC
Simulations</a></p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Philip Delff.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>



  <script data-goatcounter="https://nmsim.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script>
</body>
</html>
